#!/bin/bash

# FRP ä¸€ä½“åŒ–ç®¡ç†è„šæœ¬
# æ”¯æŒå®‰è£…ã€ç®¡ç†ã€å¸è½½ FRP æœåŠ¡ - ç±»ä¼¼å®å¡”é¢æ¿çš„ bt å‘½ä»¤

# é…ç½®å˜é‡
FRP_VERSION="0.65.0"
INSTALL_DIR="/opt/frp"
CONFIG_DIR="/etc/frp"
LOG_DIR="/var/log/frp"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PACKAGES_DIR="$SCRIPT_DIR/frp_packages"

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' 

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

# æ£€æŸ¥rootæƒé™
check_root() {
    local command_name="$1"
    if [[ $EUID -ne 0 ]]; then
        log_error "æ­¤å‘½ä»¤éœ€è¦rootæƒé™è¿è¡Œ"
        log_info "è¯·ä½¿ç”¨: sudo frp $command_name"
        exit 1
    fi
}

# æ£€æµ‹æ“ä½œç³»ç»Ÿå’Œæ¶æ„ï¼ˆé™é»˜ç‰ˆæœ¬ï¼Œåªè¿”å›ç»“æœï¼‰
detect_os_arch_silent() {
    local os arch os_name os_version

    # æ£€æµ‹æ“ä½œç³»ç»Ÿ
    case "$OSTYPE" in
        linux-gnu*)
            os="linux"
            # æ£€æµ‹å…·ä½“çš„Linuxå‘è¡Œç‰ˆ
            if [[ -f /etc/os-release ]]; then
                # è¯»å–ç³»ç»Ÿä¿¡æ¯
                . /etc/os-release
                os_name="${NAME:-Unknown}"
                os_version="${VERSION_ID:-Unknown}"
            elif [[ -f /etc/redhat-release ]]; then
                os_name="Red Hat"
                os_version=$(cat /etc/redhat-release | grep -oE '[0-9]+\.[0-9]+' | head -1)
            elif [[ -f /etc/debian_version ]]; then
                os_name="Debian"
                os_version=$(cat /etc/debian_version)
            else
                os_name="Linux"
                os_version="Unknown"
            fi
            ;;
        darwin*)
            os="darwin"
            os_version=$(sw_vers -productVersion 2>/dev/null || echo "Unknown")
            os_name="macOS"
            ;;
        freebsd*)
            os="freebsd"
            os_name="FreeBSD"
            os_version=$(uname -r)
            ;;
        openbsd*)
            os="openbsd"
            os_name="OpenBSD"
            os_version=$(uname -r)
            ;;
        *)
            echo "ERROR: ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $OSTYPE" >&2
            exit 1
            ;;
    esac

    # æ£€æµ‹æ¶æ„
    local machine=$(uname -m)
    case $machine in
        x86_64|amd64)
            arch="amd64"
            ;;
        aarch64|arm64)
            arch="arm64"
            ;;
        armv7l|armv7)
            # æ£€æŸ¥æ˜¯å¦æ”¯æŒç¡¬æµ®ç‚¹
            if [[ -f /proc/cpuinfo ]] && grep -q "hf" /proc/cpuinfo 2>/dev/null; then
                arch="arm_hf"
            elif [[ -f /proc/cpuinfo ]] && grep -q "vfp" /proc/cpuinfo 2>/dev/null; then
                arch="arm_hf"
            else
                arch="arm"
            fi
            ;;
        armv6l)
            arch="arm"
            ;;
        mips64*)
            # æ£€æŸ¥å­—èŠ‚åº
            if [[ "$(echo -n I | od -to2 | head -n1 | cut -f2 -d' ' | cut -c6 2>/dev/null)" == "1" ]]; then
                arch="mips64le"
            else
                arch="mips64"
            fi
            ;;
        mips*)
            arch="mips"
            ;;
        loongarch64)
            arch="loong64"
            ;;
        riscv64)
            arch="riscv64"
            ;;
        ppc64le)
            arch="ppc64le"
            ;;
        ppc64)
            arch="ppc64"
            ;;
        s390x)
            arch="s390x"
            ;;
        i386|i686)
            arch="386"
            ;;
        *)
            echo "ERROR: ä¸æ”¯æŒçš„æ¶æ„: $machine" >&2
            exit 1
            ;;
    esac

    # ç‰¹æ®Šå¤„ç† Android
    if [[ -f /system/build.prop ]]; then
        os="android"
        os_name="Android"
        os_version=$(grep "ro.build.version.release" /system/build.prop | cut -d'=' -f2 2>/dev/null || echo "Unknown")
    fi

    echo "${os}_${arch}"
}

# æ£€æµ‹æ“ä½œç³»ç»Ÿå’Œæ¶æ„ï¼ˆå¸¦æ—¥å¿—è¾“å‡ºï¼‰
detect_os_arch() {
    local os_arch=$(detect_os_arch_silent)
    local os="${os_arch%%_*}"
    local arch="${os_arch##*_}"
    local os_name os_version

    # æ£€æµ‹æ“ä½œç³»ç»Ÿè¯¦ç»†ä¿¡æ¯ç”¨äºæ˜¾ç¤º
    case "$OSTYPE" in
        linux-gnu*)
            if [[ -f /etc/os-release ]]; then
                . /etc/os-release
                os_name="${NAME:-Unknown}"
                os_version="${VERSION_ID:-Unknown}"
                log_info "æ£€æµ‹åˆ° Linux å‘è¡Œç‰ˆ: $os_name $os_version"

                # æ£€æŸ¥æ˜¯å¦æ”¯æŒsystemd
                if ! command -v systemctl >/dev/null 2>&1; then
                    log_warn "å½“å‰ç³»ç»Ÿæœªæ£€æµ‹åˆ° systemctlï¼Œå¯èƒ½ä¸æ”¯æŒ systemd æœåŠ¡ç®¡ç†"
                    log_warn "å»ºè®®ä½¿ç”¨ systemd ç®¡ç†çš„ Linux å‘è¡Œç‰ˆ"
                fi
            elif [[ -f /etc/redhat-release ]]; then
                os_name="Red Hat"
                os_version=$(cat /etc/redhat-release | grep -oE '[0-9]+\.[0-9]+' | head -1)
                log_info "æ£€æµ‹åˆ° Red Hat ç³»åˆ—: $os_name $os_version"
            elif [[ -f /etc/debian_version ]]; then
                os_name="Debian"
                os_version=$(cat /etc/debian_version)
                log_info "æ£€æµ‹åˆ° Debian ç³»åˆ—: $os_name $os_version"
            else
                log_warn "æ— æ³•è¯†åˆ«å…·ä½“çš„ Linux å‘è¡Œç‰ˆï¼Œå°†ä½¿ç”¨é€šç”¨ Linux æ”¯æŒ"
                os_name="Linux"
                os_version="Unknown"
            fi
            ;;
        darwin*)
            os_version=$(sw_vers -productVersion 2>/dev/null || echo "Unknown")
            os_name="macOS"
            log_info "æ£€æµ‹åˆ° macOS ç‰ˆæœ¬: $os_version"

            # æ£€æŸ¥æ˜¯å¦æ”¯æŒlaunchd (macOSçš„æœåŠ¡ç®¡ç†)
            if ! command -v launchctl >/dev/null 2>&1; then
                log_warn "æœªæ£€æµ‹åˆ° launchctlï¼ŒmacOS æœåŠ¡ç®¡ç†å¯èƒ½ä¸å¯ç”¨"
            fi
            ;;
        freebsd*)
            os_name="FreeBSD"
            os_version=$(uname -r)
            log_info "æ£€æµ‹åˆ° FreeBSD ç‰ˆæœ¬: $os_version"
            ;;
        openbsd*)
            os_name="OpenBSD"
            os_version=$(uname -r)
            log_info "æ£€æµ‹åˆ° OpenBSD ç‰ˆæœ¬: $os_version"
            ;;
    esac

    # æ˜¾ç¤ºæ¶æ„ä¿¡æ¯
    case "$arch" in
        arm_hf)
            log_info "æ£€æµ‹åˆ° ARM ç¡¬æµ®ç‚¹æ¶æ„"
            ;;
        arm)
            log_info "æ£€æµ‹åˆ° ARM æ¶æ„"
            ;;
        mips64le)
            log_info "æ£€æµ‹åˆ° MIPS64 å°ç«¯åºæ¶æ„"
            ;;
        mips64)
            log_info "æ£€æµ‹åˆ° MIPS64 å¤§ç«¯åºæ¶æ„"
            ;;
        mips)
            log_info "æ£€æµ‹åˆ° MIPS æ¶æ„"
            ;;
        loong64)
            log_info "æ£€æµ‹åˆ°é¾™èŠ¯ LoongArch64 æ¶æ„"
            ;;
        riscv64)
            log_info "æ£€æµ‹åˆ° RISC-V 64ä½æ¶æ„"
            ;;
        ppc64le)
            log_info "æ£€æµ‹åˆ° PowerPC 64ä½å°ç«¯åºæ¶æ„"
            ;;
        ppc64)
            log_info "æ£€æµ‹åˆ° PowerPC 64ä½å¤§ç«¯åºæ¶æ„"
            ;;
        s390x)
            log_info "æ£€æµ‹åˆ° IBM System z æ¶æ„"
            ;;
        "386")
            log_info "æ£€æµ‹åˆ° 32ä½ x86 æ¶æ„"
            ;;
    esac

    # ç‰¹æ®Šå¤„ç† Android
    if [[ "$os" == "android" ]]; then
        os_name="Android"
        os_version=$(grep "ro.build.version.release" /system/build.prop | cut -d'=' -f2 2>/dev/null || echo "Unknown")
        log_info "æ£€æµ‹åˆ° Android ç³»ç»Ÿç‰ˆæœ¬: $os_version"
    fi

    # æ˜¾ç¤ºæœ€ç»ˆæ£€æµ‹ç»“æœ
    log_info "ç³»ç»Ÿæ£€æµ‹å®Œæˆ: ${os_name:-$os} ${os_version:-} ($os $arch)"

    # åªè¿”å›æ¶æ„å­—ç¬¦ä¸²ï¼Œä¸åŒ…å«ä»»ä½•æ—¥å¿—
    echo "$os_arch"
}

# æŸ¥æ‰¾å¯¹åº”çš„å®‰è£…åŒ…
find_package() {
    local os_arch="$1"
    local package_pattern="frp_${FRP_VERSION}_${os_arch}.tar.gz"
    local package_path="$PACKAGES_DIR/$package_pattern"

    if [[ -f "$package_path" ]]; then
        # åªè¾“å‡ºæ–‡ä»¶è·¯å¾„åˆ° stdout
        echo "$package_path"
        return 0
    else
        # é”™è¯¯ä¿¡æ¯è¾“å‡ºåˆ° stderr
        log_error "æœªæ‰¾åˆ°å¯¹åº”çš„å®‰è£…åŒ…: $package_pattern" >&2
        log_info "å¯ç”¨çš„å®‰è£…åŒ…:" >&2
        ls -1 "$PACKAGES_DIR"/frp_*.tar.gz 2>/dev/null | sed 's/.*frp_/  frp_/' >&2 || true
        log_info "å½“å‰ç³»ç»Ÿæ¶æ„: $os_arch" >&2
        log_info "è¯·ç¡®ä¿ frp_packages ç›®å½•åŒ…å«å¯¹åº”çš„å®‰è£…åŒ…" >&2
        exit 1
    fi
}

# ç³»ç»Ÿå…¼å®¹æ€§æ£€æŸ¥
check_system_compatibility() {
    local os_arch="$1"
    local os="${os_arch%%_*}"

    log_info "æ£€æŸ¥ç³»ç»Ÿå…¼å®¹æ€§..."

    # æ£€æŸ¥å¿…è¦çš„å‘½ä»¤
    local required_commands=("tar" "gzip")
    for cmd in "${required_commands[@]}"; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            log_error "ç¼ºå°‘å¿…è¦çš„å‘½ä»¤: $cmd"
            log_info "è¯·å®‰è£…ç›¸åº”çš„è½¯ä»¶åŒ…"
            exit 1
        fi
    done

    # æ ¹æ®æ“ä½œç³»ç»Ÿæ£€æŸ¥ç‰¹å®šè¦æ±‚
    case "$os" in
        linux)
            # æ£€æŸ¥systemd
            if ! command -v systemctl >/dev/null 2>&1; then
                log_warn "æœªæ£€æµ‹åˆ° systemctlï¼Œsystemd æœåŠ¡ç®¡ç†ä¸å¯ç”¨"
                log_warn "FRP æœåŠ¡å°†æ— æ³•è‡ªåŠ¨å¯åŠ¨ï¼Œè¯·æ‰‹åŠ¨ç®¡ç†"
                log_warn "å»ºè®®ä½¿ç”¨æ”¯æŒ systemd çš„ Linux å‘è¡Œç‰ˆ"
            else
                log_info "æ£€æµ‹åˆ° systemd æœåŠ¡ç®¡ç†å™¨ âœ“"
            fi

            # æ£€æŸ¥ç½‘ç»œå·¥å…·
            if ! command -v curl >/dev/null 2>&1 && ! command -v wget >/dev/null 2>&1; then
                log_warn "æœªæ£€æµ‹åˆ° curl æˆ– wgetï¼Œç½‘ç»œè¿æ¥æµ‹è¯•å¯èƒ½å—é™"
            fi
            ;;
        darwin)
            # æ£€æŸ¥launchd
            if ! command -v launchctl >/dev/null 2>&1; then
                log_warn "æœªæ£€æµ‹åˆ° launchctlï¼ŒmacOS æœåŠ¡ç®¡ç†ä¸å¯ç”¨"
                log_warn "FRP æœåŠ¡å°†æ— æ³•è‡ªåŠ¨å¯åŠ¨"
            else
                log_info "æ£€æµ‹åˆ° launchd æœåŠ¡ç®¡ç†å™¨ âœ“"
            fi
            ;;
        freebsd|openbsd)
            # æ£€æŸ¥rc
            if [[ ! -d /etc/rc.d ]] && [[ ! -d /usr/local/etc/rc.d ]]; then
                log_warn "æœªæ£€æµ‹åˆ°æ ‡å‡†çš„ rc è„šæœ¬ç›®å½•"
                log_warn "BSD æœåŠ¡ç®¡ç†å¯èƒ½ä¸å¯ç”¨"
            else
                log_info "æ£€æµ‹åˆ° BSD rc æœåŠ¡ç®¡ç†ç³»ç»Ÿ âœ“"
            fi
            ;;
    esac

    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    local required_space_mb=50
    # ä½¿ç”¨ /tmp æˆ– / ä½œä¸ºæ£€æŸ¥ç›®å½•ï¼Œå› ä¸ºå®‰è£…ç›®å½•å¯èƒ½è¿˜ä¸å­˜åœ¨
    local check_dir="/"
    if [[ -d "/tmp" ]]; then
        check_dir="/tmp"
    fi
    local available_space=$(df -m "$check_dir" 2>/dev/null | tail -1 | awk '{print $4}' | grep -E '^[0-9]+$' || echo "0")
    if [[ -z "$available_space" ]] || [[ "$available_space" == "0" ]]; then
        available_space="0"
    fi
    if [[ $available_space -lt $required_space_mb ]]; then
        log_warn "ç³»ç»Ÿå¯ç”¨ç©ºé—´ä¸è¶³ ${required_space_mb}MB (å½“å‰: ${available_space}MB)"
        log_warn "å¯èƒ½å¯¼è‡´å®‰è£…å¤±è´¥"
    else
        log_info "ç£ç›˜ç©ºé—´å……è¶³ âœ“ (å¯ç”¨: ${available_space}MB)"
    fi

    # æ£€æŸ¥å†…å­˜
    local total_mem_kb=$(grep MemTotal /proc/meminfo 2>/dev/null | awk '{print $2}' || echo "0")
    local total_mem_mb=$((total_mem_kb / 1024))
    if [[ $total_mem_mb -lt 128 ]]; then
        log_warn "ç³»ç»Ÿå†…å­˜ä¸è¶³ 128MB (å½“å‰: ${total_mem_mb}MB)"
        log_warn "FRP å¯èƒ½æ— æ³•æ­£å¸¸è¿è¡Œ"
    else
        log_info "ç³»ç»Ÿå†…å­˜å……è¶³ âœ“"
    fi

    log_info "ç³»ç»Ÿå…¼å®¹æ€§æ£€æŸ¥å®Œæˆ"
}

# åˆ›å»ºç›®å½•
create_directories() {
    log_info "åˆ›å»ºå¿…è¦ç›®å½•..."
    mkdir -p "$INSTALL_DIR"
    mkdir -p "$CONFIG_DIR"
    mkdir -p "$LOG_DIR"
}

# è§£å‹å®‰è£…åŒ…
extract_package() {
    local package_path="$1"
    
    if [[ -z "$package_path" ]] || [[ ! -f "$package_path" ]]; then
        log_error "å®‰è£…åŒ…è·¯å¾„æ— æ•ˆæˆ–æ–‡ä»¶ä¸å­˜åœ¨: $package_path"
        exit 1
    fi
    
    local package_name=$(basename "$package_path" .tar.gz)
    local temp_dir=$(mktemp -d)

    log_info "è§£å‹å®‰è£…åŒ…: $package_name"
    
    # è§£å‹åˆ°ä¸´æ—¶ç›®å½•
    if ! tar -xzf "$package_path" -C "$temp_dir"; then
        log_error "è§£å‹å®‰è£…åŒ…å¤±è´¥: $package_path"
        rm -rf "$temp_dir"
        exit 1
    fi

    # æŸ¥æ‰¾ frps å’Œ frpc æ–‡ä»¶ï¼ˆå¯èƒ½åœ¨å­ç›®å½•ä¸­ï¼‰
    local frps_file=$(find "$temp_dir" -name "frps" -type f | head -1)
    local frpc_file=$(find "$temp_dir" -name "frpc" -type f | head -1)

    if [[ -z "$frps_file" ]] || [[ -z "$frpc_file" ]]; then
        log_error "å®‰è£…åŒ…ä¸­ç¼ºå°‘å¿…è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶"
        log_info "è§£å‹åçš„ç›®å½•ç»“æ„:"
        find "$temp_dir" -type f -name "frp*" | head -10
        rm -rf "$temp_dir"
        exit 1
    fi

    # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶åˆ°å®‰è£…ç›®å½•
    log_info "å¤åˆ¶ FRP äºŒè¿›åˆ¶æ–‡ä»¶..."
    cp "$frps_file" "$INSTALL_DIR/frps"
    cp "$frpc_file" "$INSTALL_DIR/frpc"
    
    # è®¾ç½®æ‰§è¡Œæƒé™
    chmod +x "$INSTALL_DIR/frps"
    chmod +x "$INSTALL_DIR/frpc"

    # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–æœ‰ç”¨çš„æ–‡ä»¶ï¼ˆå¦‚ç¤ºä¾‹é…ç½®æ–‡ä»¶ï¼‰
    if find "$temp_dir" -name "*.toml" -o -name "*.ini" -o -name "LICENSE" | grep -q .; then
        log_info "å‘ç°é…ç½®æ–‡ä»¶æˆ–æ–‡æ¡£ï¼Œå·²ä¿å­˜åˆ° $INSTALL_DIR"
        find "$temp_dir" -type f \( -name "*.toml" -o -name "*.ini" -o -name "LICENSE" -o -name "README*" \) -exec cp {} "$INSTALL_DIR/" \;
    fi

    # æ¸…ç†ä¸´æ—¶ç›®å½•
    rm -rf "$temp_dir"

    # éªŒè¯æ–‡ä»¶å·²æ­£ç¡®å®‰è£…
    if [[ ! -f "$INSTALL_DIR/frps" ]] || [[ ! -f "$INSTALL_DIR/frpc" ]]; then
        log_error "æ–‡ä»¶å¤åˆ¶å¤±è´¥"
        exit 1
    fi

    if [[ ! -x "$INSTALL_DIR/frps" ]] || [[ ! -x "$INSTALL_DIR/frpc" ]]; then
        log_error "æ–‡ä»¶æƒé™è®¾ç½®å¤±è´¥"
        exit 1
    fi

    log_info "å®‰è£…åŒ…è§£å‹å®Œæˆ"
    log_info "FRP äºŒè¿›åˆ¶æ–‡ä»¶å·²å®‰è£…åˆ°: $INSTALL_DIR"
}

# éªŒè¯å¿…å¡«è¾“å…¥
validate_required_input() {
    local prompt="$1"
    local var_name="$2"
    local default_value="${3:-}"
    local allow_empty="${4:-false}"
    
    while true; do
        if [[ -n "$default_value" ]]; then
            read -p "$prompt [é»˜è®¤$default_value]: " input
            input=${input:-$default_value}
        else
            read -p "$prompt: " input
        fi
        
        if [[ -z "$input" ]] && [[ "$allow_empty" != "true" ]]; then
            log_error "æ­¤é¡¹ä¸èƒ½ä¸ºç©ºï¼Œè¯·é‡æ–°è¾“å…¥"
            continue
        fi
        
        eval "$var_name=\"$input\""
        break
    done
}

# éªŒè¯ç«¯å£å·
validate_port() {
    local prompt="$1"
    local var_name="$2"
    local default_value="${3:-}"
    
    while true; do
        if [[ -n "$default_value" ]]; then
            read -p "$prompt [é»˜è®¤$default_value]: " input
            input=${input:-$default_value}
        else
            read -p "$prompt: " input
        fi
        
        if [[ -z "$input" ]]; then
            log_error "ç«¯å£ä¸èƒ½ä¸ºç©ºï¼Œè¯·é‡æ–°è¾“å…¥"
            continue
        fi
        
        if ! [[ "$input" =~ ^[0-9]+$ ]]; then
            log_error "ç«¯å£å¿…é¡»æ˜¯æ•°å­—ï¼Œè¯·é‡æ–°è¾“å…¥"
            continue
        fi
        
        if (( input < 1 || input > 65535 )); then
            log_error "ç«¯å£å¿…é¡»åœ¨ 1-65535 ä¹‹é—´ï¼Œè¯·é‡æ–°è¾“å…¥"
            continue
        fi
        
        eval "$var_name=\"$input\""
        break
    done
}

# é…ç½®frps
setup_frps() {
    log_info "å¼€å§‹é…ç½®FRPæœåŠ¡å™¨ (frps)..."

    # è·å–ç”¨æˆ·è¾“å…¥
    validate_port "è¯·è¾“å…¥frpsç›‘å¬ç«¯å£" "bind_port" "7000"

    validate_required_input "è¯·è¾“å…¥frpsç›‘å¬åœ°å€" "bind_addr" "0.0.0.0"

    read -p "è¯·è¾“å…¥è®¤è¯ä»¤ç‰Œ (token) [ç•™ç©ºéšæœºç”Ÿæˆ]: " auth_token
    if [[ -z "$auth_token" ]]; then
        auth_token=$(openssl rand -hex 16)
        log_info "ç”Ÿæˆçš„éšæœºtoken: $auth_token"
    fi

    read -p "è¯·è¾“å…¥ç®¡ç†é¢æ¿ç«¯å£ [é»˜è®¤7500ï¼Œç•™ç©ºç¦ç”¨]: " dashboard_port
    dashboard_port=${dashboard_port:-7500}

    if [[ -n "$dashboard_port" ]] && [[ "$dashboard_port" != "0" ]]; then
        # éªŒè¯ç®¡ç†é¢æ¿ç«¯å£
        if ! [[ "$dashboard_port" =~ ^[0-9]+$ ]] || (( dashboard_port < 1 || dashboard_port > 65535 )); then
            log_warn "ç®¡ç†é¢æ¿ç«¯å£æ— æ•ˆï¼Œå·²ç¦ç”¨"
            dashboard_port=""
        else
            validate_required_input "è¯·è¾“å…¥ç®¡ç†é¢æ¿ç”¨æˆ·å" "dashboard_user" "admin"
            validate_required_input "è¯·è¾“å…¥ç®¡ç†é¢æ¿å¯†ç " "dashboard_pwd" "admin"
        fi
    else
        dashboard_port=""
    fi

    validate_required_input "è¯·è¾“å…¥TCPå¤ç”¨ç«¯å£" "proxy_bind_addr" "0.0.0.0:7001"

    # ç”Ÿæˆé…ç½®æ–‡ä»¶
    cat > "$CONFIG_DIR/frps.toml" << EOF
# FRPæœåŠ¡å™¨é…ç½®æ–‡ä»¶ - è‡ªåŠ¨ç”Ÿæˆ

# æœåŠ¡å™¨ç»‘å®šè®¾ç½®
bindAddr = "$bind_addr"
bindPort = $bind_port

# è®¤è¯è®¾ç½®
auth.method = "token"
auth.token = "$auth_token"

# æ—¥å¿—è®¾ç½®
log.to = "$LOG_DIR/frps.log"
log.level = "info"
log.maxDays = 3

EOF

    # å¦‚æœå¯ç”¨äº†ç®¡ç†é¢æ¿ï¼Œæ·»åŠ é¢æ¿é…ç½®
    if [[ -n "$dashboard_port" ]]; then
        cat >> "$CONFIG_DIR/frps.toml" << EOF
# ç®¡ç†é¢æ¿è®¾ç½®
webServer.addr = "0.0.0.0"
webServer.port = $dashboard_port
webServer.user = "$dashboard_user"
webServer.password = "$dashboard_pwd"

EOF
    fi

    log_info "FRPæœåŠ¡å™¨é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ: $CONFIG_DIR/frps.toml"

    # åˆ›å»ºsystemdæœåŠ¡
    create_frps_service

    log_info "FRPæœåŠ¡å™¨é…ç½®å®Œæˆ!"
    log_info "æœåŠ¡å™¨åœ°å€: $bind_addr:$bind_port"
    log_info "è®¤è¯ä»¤ç‰Œ: $auth_token"
    if [[ -n "$dashboard_port" ]]; then
        log_info "ç®¡ç†é¢æ¿: http://localhost:$dashboard_port"
        log_info "é¢æ¿ç”¨æˆ·å: $dashboard_user"
        log_info "é¢æ¿å¯†ç : $dashboard_pwd"
    fi
}

# é…ç½®frpc
setup_frpc() {
    log_info "å¼€å§‹é…ç½®FRPå®¢æˆ·ç«¯ (frpc)..."

    # è·å–æœåŠ¡å™¨ä¿¡æ¯
    validate_required_input "è¯·è¾“å…¥FRPæœåŠ¡å™¨IPåœ°å€" "server_addr"
    
    validate_port "è¯·è¾“å…¥FRPæœåŠ¡å™¨ç«¯å£" "server_port" "7000"

    validate_required_input "è¯·è¾“å…¥è®¤è¯ä»¤ç‰Œ (token)" "auth_token"

    # è·å–æœ¬åœ°æœåŠ¡ä¿¡æ¯
    read -p "è¯·è¾“å…¥æœ¬åœ°æœåŠ¡ç±»å‹ [tcp/http] [é»˜è®¤tcp]: " proxy_type
    proxy_type=${proxy_type:-tcp}
    
    if [[ "$proxy_type" != "tcp" ]] && [[ "$proxy_type" != "http" ]]; then
        log_warn "æ— æ•ˆçš„ä»£ç†ç±»å‹ï¼Œä½¿ç”¨é»˜è®¤å€¼ tcp"
        proxy_type="tcp"
    fi

    validate_required_input "è¯·è¾“å…¥ä»£ç†åç§°" "proxy_name" "my_proxy"

    validate_required_input "è¯·è¾“å…¥æœ¬åœ°IPåœ°å€" "local_ip" "127.0.0.1"

    validate_port "è¯·è¾“å…¥æœ¬åœ°ç«¯å£" "local_port"

    if [[ "$proxy_type" == "tcp" ]]; then
        validate_port "è¯·è¾“å…¥è¿œç¨‹ç«¯å£" "remote_port"
        custom_domain=""
    else  # http
        read -p "è¯·è¾“å…¥è‡ªå®šä¹‰åŸŸå [ç•™ç©ºä½¿ç”¨ç«¯å£]: " custom_domain
        if [[ -z "$custom_domain" ]]; then
            validate_port "è¯·è¾“å…¥è¿œç¨‹ç«¯å£" "remote_port"
        else
            remote_port=""
        fi
    fi

    # ç”Ÿæˆé…ç½®æ–‡ä»¶
    cat > "$CONFIG_DIR/frpc.toml" << EOF
# FRPå®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ - è‡ªåŠ¨ç”Ÿæˆ

# æœåŠ¡å™¨è®¾ç½®
serverAddr = "$server_addr"
serverPort = $server_port

# è®¤è¯è®¾ç½®
auth.method = "token"
auth.token = "$auth_token"

# æ—¥å¿—è®¾ç½®
log.to = "$LOG_DIR/frpc.log"
log.level = "info"
log.maxDays = 3

EOF

    # æ·»åŠ ä»£ç†é…ç½®
    if [[ "$proxy_type" == "tcp" ]]; then
        cat >> "$CONFIG_DIR/frpc.toml" << EOF
# TCPä»£ç†é…ç½®
[[proxies]]
name = "$proxy_name"
type = "tcp"
localIP = "$local_ip"
localPort = $local_port
remotePort = $remote_port

EOF
    else  # http
        cat >> "$CONFIG_DIR/frpc.toml" << EOF
# HTTPä»£ç†é…ç½®
[[proxies]]
name = "$proxy_name"
type = "http"
localIP = "$local_ip"
localPort = $local_port

EOF
        if [[ -n "$custom_domain" ]]; then
            echo "customDomains = [\"$custom_domain\"]" >> "$CONFIG_DIR/frpc.toml"
        else
            echo "remotePort = $remote_port" >> "$CONFIG_DIR/frpc.toml"
        fi
    fi

    log_info "FRPå®¢æˆ·ç«¯é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ: $CONFIG_DIR/frpc.toml"

    # åˆ›å»ºsystemdæœåŠ¡
    create_frpc_service

    log_info "FRPå®¢æˆ·ç«¯é…ç½®å®Œæˆ!"
    log_info "è¿æ¥åˆ°æœåŠ¡å™¨: $server_addr:$server_port"
    if [[ "$proxy_type" == "tcp" ]]; then
        log_info "æœ¬åœ°æœåŠ¡: $local_ip:$local_port -> è¿œç¨‹ç«¯å£: $remote_port"
    else
        if [[ -n "$custom_domain" ]]; then
            log_info "æœ¬åœ°æœåŠ¡: $local_ip:$local_port -> åŸŸå: $custom_domain"
        else
            log_info "æœ¬åœ°æœåŠ¡: $local_ip:$local_port -> è¿œç¨‹ç«¯å£: $remote_port"
        fi
    fi
}

# åˆ›å»ºfrps systemdæœåŠ¡
create_frps_service() {
    log_info "åˆ›å»ºfrps systemdæœåŠ¡..."

    cat > /etc/systemd/system/frps.service << EOF
[Unit]
Description=FRP Server
After=network.target
Wants=network.target

[Service]
Type=simple
ExecStart=$INSTALL_DIR/frps -c $CONFIG_DIR/frps.toml
Restart=on-failure
RestartSec=5s
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable frps
    systemctl start frps

    log_info "frpsæœåŠ¡å·²åˆ›å»ºå¹¶å¯åŠ¨"
}

# åˆ›å»ºfrpc systemdæœåŠ¡
create_frpc_service() {
    log_info "åˆ›å»ºfrpc systemdæœåŠ¡..."

    cat > /etc/systemd/system/frpc.service << EOF
[Unit]
Description=FRP Client
After=network.target
Wants=network.target

[Service]
Type=simple
ExecStart=$INSTALL_DIR/frpc -c $CONFIG_DIR/frpc.toml
Restart=on-failure
RestartSec=5s
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable frpc
    systemctl start frpc

    log_info "frpcæœåŠ¡å·²åˆ›å»ºå¹¶å¯åŠ¨"
}

# æ£€æŸ¥FRPæ˜¯å¦å·²å®‰è£…
check_installation() {
    if [[ -d "$INSTALL_DIR" ]] && [[ -f "$INSTALL_DIR/frps" ]] && [[ -f "$INSTALL_DIR/frpc" ]]; then
        # æ£€æµ‹æ˜¯frpsè¿˜æ˜¯frpc
        if [[ -f "$CONFIG_DIR/frps.toml" ]]; then
            FRP_TYPE="server"
            SERVICE_NAME="frps"
            CONFIG_FILE="$CONFIG_DIR/frps.toml"
            EXECUTABLE="$INSTALL_DIR/frps"
        elif [[ -f "$CONFIG_DIR/frpc.toml" ]]; then
            FRP_TYPE="client"
            SERVICE_NAME="frpc"
            CONFIG_FILE="$CONFIG_DIR/frpc.toml"
            EXECUTABLE="$INSTALL_DIR/frpc"
        else
            FRP_TYPE="unknown"
            SERVICE_NAME=""
            CONFIG_FILE=""
            EXECUTABLE=""
        fi
        return 0  # å·²å®‰è£…
    else
        return 1  # æœªå®‰è£…
    fi
}

# æ˜¾ç¤ºæœªå®‰è£…æ—¶çš„å¸®åŠ©ä¿¡æ¯
show_uninstalled_help() {
    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        FRP ä¸€ä½“åŒ–ç®¡ç†å·¥å…·${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo
    echo -e "${YELLOW}äº¤äº’å¼å®‰è£…:${NC}"
    echo "  ç›´æ¥è¿è¡Œ 'frp' è¿›å…¥äº¤äº’å¼å®‰è£…èœå•"
    echo "  æˆ–ä½¿ç”¨ 'frp install server/client' ç›´æ¥å®‰è£…"
    echo
    echo -e "${YELLOW}FRP æœªå®‰è£…ï¼Œè¯·é€‰æ‹©å®‰è£…ç±»å‹ï¼š${NC}"
    echo
    echo "  install server    å®‰è£… FRP æœåŠ¡å™¨ (frps)"
    echo "  install client    å®‰è£… FRP å®¢æˆ·ç«¯ (frpc)"
    echo "  help              æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo "  version           æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
    echo
    echo -e "${YELLOW}ç¤ºä¾‹ï¼š${NC}"
    echo "  frp install server    # å®‰è£… FRP æœåŠ¡å™¨"
    echo "  frp install client    # å®‰è£… FRP å®¢æˆ·ç«¯"
    echo
}

# æ˜¾ç¤ºå·²å®‰è£…æ—¶çš„å¸®åŠ©ä¿¡æ¯
show_installed_help() {
    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        FRP ç®¡ç†å·¥å…· v1.0${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo
    echo -e "${YELLOW}ğŸ’¡ äº¤äº’å¼èœå•æ¨¡å¼:${NC}"
    echo "  ç›´æ¥è¿è¡Œ 'frp' (ä¸å¸¦ä»»ä½•å‚æ•°) å³å¯è¿›å…¥äº¤äº’å¼èœå•"
    echo "  é€šè¿‡è¾“å…¥æ•°å­— 1ã€2ã€3... æ¥é€‰æ‹©åŠŸèƒ½"
    echo
    echo -e "${YELLOW}ğŸ“ å‘½ä»¤è¡Œæ¨¡å¼:${NC}"
    echo "  ä½¿ç”¨ 'frp <å‘½ä»¤>' ç›´æ¥æ‰§è¡Œå‘½ä»¤"
    echo
    echo -e "${CYAN}åŸºç¡€å‘½ä»¤:${NC}"
    echo "  start         å¯åŠ¨ FRP æœåŠ¡"
    echo "  stop          åœæ­¢ FRP æœåŠ¡"
    echo "  restart       é‡å¯ FRP æœåŠ¡"
    echo "  status        æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  reload        é‡æ–°åŠ è½½é…ç½®"
    echo
    echo -e "${CYAN}é…ç½®ç®¡ç†:${NC}"
    echo "  config        æŸ¥çœ‹å½“å‰é…ç½®"
    echo "  edit          ç¼–è¾‘é…ç½®æ–‡ä»¶"
    echo "  test          æµ‹è¯•é…ç½®è¯­æ³•"
    echo "  backup        å¤‡ä»½å½“å‰é…ç½®"
    echo "  restore       ä»å¤‡ä»½æ¢å¤é…ç½®"
    echo
    echo -e "${CYAN}ä»£ç†è§„åˆ™ç®¡ç† (ä»…å®¢æˆ·ç«¯):${NC}"
    echo "  proxy list    åˆ—å‡ºæ‰€æœ‰ä»£ç†è§„åˆ™"
    echo "  proxy add     æ·»åŠ æ–°çš„ä»£ç†è§„åˆ™"
    echo "  proxy delete  åˆ é™¤ä»£ç†è§„åˆ™"
    echo "  proxy edit    ç¼–è¾‘ä»£ç†è§„åˆ™"
    echo "  proxy show    æ˜¾ç¤ºä»£ç†è§„åˆ™è¯¦æƒ…"
    echo
    echo -e "${CYAN}ç›‘æ§å’Œæ—¥å¿—:${NC}"
    echo "  logs          æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo "  logf          æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶"
    echo "  monitor       ç›‘æ§æœåŠ¡çŠ¶æ€"
    echo
    echo -e "${CYAN}ä¿¡æ¯æŸ¥è¯¢:${NC}"
    echo "  version       æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
    echo "  info          æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯"
    echo "  connections   æ˜¾ç¤ºè¿æ¥ä¿¡æ¯ (ä»…æœåŠ¡ç«¯)"
    echo
    echo -e "${CYAN}å…¶ä»–:${NC}"
    echo "  help                 æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo "  uninstall            å¸è½½å½“å‰ FRP ç»„ä»¶"
    echo "  uninstall server     ä»…å¸è½½ FRP æœåŠ¡å™¨ (frps)"
    echo "  uninstall client     ä»…å¸è½½ FRP å®¢æˆ·ç«¯ (frpc)"
    echo "  uninstall all        å¸è½½ FRP åŠæ‰€æœ‰é…ç½®/æ—¥å¿—"
    echo
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  frp start     # å¯åŠ¨æœåŠ¡"
    echo "  frp status    # æŸ¥çœ‹çŠ¶æ€"
    echo "  frp edit      # ç¼–è¾‘é…ç½®"
    echo "  frp logs      # æŸ¥çœ‹æ—¥å¿—"
    echo
}

# å¯åŠ¨æœåŠ¡
cmd_start() {
    check_root "start"

    if systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
        log_warn "FRP $FRP_TYPE æœåŠ¡å·²åœ¨è¿è¡Œ"
        return
    fi

    log_info "å¯åŠ¨ FRP $FRP_TYPE æœåŠ¡..."
    if systemctl start "$SERVICE_NAME" 2>/dev/null; then
        sleep 2
        if systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
            log_success "FRP $FRP_TYPE æœåŠ¡å¯åŠ¨æˆåŠŸ"
        else
            log_error "FRP $FRP_TYPE æœåŠ¡å¯åŠ¨å¤±è´¥"
            log_info "æŸ¥çœ‹æ—¥å¿—: frp logs"
        fi
    else
        log_error "å¯åŠ¨å‘½ä»¤æ‰§è¡Œå¤±è´¥"
        log_info "å°è¯•æ‰‹åŠ¨å¯åŠ¨: $EXECUTABLE -c $CONFIG_FILE"
    fi
}

# åœæ­¢æœåŠ¡
cmd_stop() {
    check_root "stop"

    if ! systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
        log_warn "FRP $FRP_TYPE æœåŠ¡æœªåœ¨è¿è¡Œ"
        return
    fi

    log_info "åœæ­¢ FRP $FRP_TYPE æœåŠ¡..."
    if systemctl stop "$SERVICE_NAME" 2>/dev/null; then
        sleep 2
        if ! systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
            log_success "FRP $FRP_TYPE æœåŠ¡å·²åœæ­¢"
        else
            log_error "FRP $FRP_TYPE æœåŠ¡åœæ­¢å¤±è´¥"
        fi
    else
        log_error "åœæ­¢å‘½ä»¤æ‰§è¡Œå¤±è´¥"
        log_info "å°è¯•æ‰‹åŠ¨åœæ­¢: pkill -f frp"
    fi
}

# é‡å¯æœåŠ¡
cmd_restart() {
    check_root "restart"

    log_info "é‡å¯ FRP $FRP_TYPE æœåŠ¡..."
    if systemctl restart "$SERVICE_NAME" 2>/dev/null; then
        sleep 3
        if systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
            log_success "FRP $FRP_TYPE æœåŠ¡é‡å¯æˆåŠŸ"
        else
            log_error "FRP $FRP_TYPE æœåŠ¡é‡å¯å¤±è´¥"
            log_info "æŸ¥çœ‹æ—¥å¿—: frp logs"
        fi
    else
        log_error "é‡å¯å‘½ä»¤æ‰§è¡Œå¤±è´¥"
        log_info "å°è¯•æ‰‹åŠ¨é‡å¯: frp stop && frp start"
    fi
}

# æŸ¥çœ‹çŠ¶æ€
cmd_status() {
    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        FRP æœåŠ¡çŠ¶æ€${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo

    # æœåŠ¡çŠ¶æ€
    echo -e "${CYAN}æœåŠ¡çŠ¶æ€:${NC}"
    if systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
        echo -e "  çŠ¶æ€: ${GREEN}è¿è¡Œä¸­${NC}"
        echo -e "  PID: $(systemctl show -p MainPID --value "$SERVICE_NAME" 2>/dev/null || echo 'æœªçŸ¥')"
        echo -e "  å¯åŠ¨æ—¶é—´: $(systemctl show -p ActiveEnterTimestamp --value "$SERVICE_NAME" 2>/dev/null || echo 'æœªçŸ¥')"
    else
        echo -e "  çŠ¶æ€: ${RED}æœªè¿è¡Œ${NC}"
        echo -e "  æœ€åé€€å‡ºä»£ç : $(systemctl show -p ExecMainStatus --value "$SERVICE_NAME" 2>/dev/null || echo 'æœªçŸ¥')"
    fi
    echo

    # æœåŠ¡ä¿¡æ¯
    echo -e "${CYAN}æœåŠ¡ä¿¡æ¯:${NC}"
    echo "  ç±»å‹: FRP $FRP_TYPE"
    echo "  æœåŠ¡å: $SERVICE_NAME"
    echo "  å¯æ‰§è¡Œæ–‡ä»¶: $EXECUTABLE"
    echo "  é…ç½®æ–‡ä»¶: $CONFIG_FILE"
    echo "  æ—¥å¿—ç›®å½•: $LOG_DIR"
    echo

    # è¿›ç¨‹ä¿¡æ¯
    echo -e "${CYAN}è¿›ç¨‹ä¿¡æ¯:${NC}"
    local pid=$(pgrep -f "$EXECUTABLE" | head -1)
    if [[ -n "$pid" ]]; then
        echo "  è¿›ç¨‹ID: $pid"
        echo -e "  CPUä½¿ç”¨ç‡: $(ps -p "$pid" -o pcpu= | tr -d ' ')%"
        echo -e "  å†…å­˜ä½¿ç”¨: $(ps -p "$pid" -o pmem= | tr -d ' ')MB"
        echo -e "  è¿è¡Œæ—¶é—´: $(ps -p "$pid" -o etime= | tr -d ' ')"
    else
        echo "  æ— ç›¸å…³è¿›ç¨‹è¿è¡Œ"
    fi
    echo

    # ç½‘ç»œç›‘å¬
    echo -e "${CYAN}ç½‘ç»œç›‘å¬:${NC}"
    if command -v netstat >/dev/null 2>&1; then
        local ports=$(netstat -tlnp 2>/dev/null | grep -E "(frps|frpc)" | awk '{print $4}' | sed 's/.*://' | sort | uniq)
        if [[ -n "$ports" ]]; then
            echo "  ç›‘å¬ç«¯å£: $ports"
        else
            echo "  æ— ç«¯å£ç›‘å¬"
        fi
    else
        echo "  netstat å‘½ä»¤ä¸å¯ç”¨"
    fi
    echo
}

# æŸ¥çœ‹é…ç½®
cmd_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        log_error "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
        return
    fi

    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        FRP é…ç½®æ–‡ä»¶${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo
    echo -e "${YELLOW}æ–‡ä»¶ä½ç½®: $CONFIG_FILE${NC}"
    echo

    # æ˜¾ç¤ºé…ç½®å†…å®¹
    if [[ -s "$CONFIG_FILE" ]]; then
        echo -e "${CYAN}é…ç½®å†…å®¹:${NC}"
        echo
        cat "$CONFIG_FILE"
    else
        echo "é…ç½®æ–‡ä»¶ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
    fi
    echo
}

# ç¼–è¾‘é…ç½®
cmd_edit() {
    check_root "edit"

    if [[ ! -f "$CONFIG_FILE" ]]; then
        log_error "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
        return
    fi

    log_info "æ­£åœ¨ç¼–è¾‘é…ç½®æ–‡ä»¶: $CONFIG_FILE"

    # å°è¯•ä¸åŒçš„ç¼–è¾‘å™¨
    local editors=("nano" "vim" "vi")
    local editor_found=""

    for editor in "${editors[@]}"; do
        if command -v "$editor" >/dev/null 2>&1; then
            editor_found="$editor"
            break
        fi
    done

    if [[ -z "$editor_found" ]]; then
        log_error "æœªæ‰¾åˆ°å¯ç”¨çš„æ–‡æœ¬ç¼–è¾‘å™¨ (nano, vim, vi)"
        log_info "è¯·æ‰‹åŠ¨ç¼–è¾‘æ–‡ä»¶: $CONFIG_FILE"
        return
    fi

    log_info "ä½¿ç”¨ç¼–è¾‘å™¨: $editor_found"
    log_warn "ç¼–è¾‘å®Œæˆåï¼Œå»ºè®®è¿è¡Œ 'frp test' æ£€æŸ¥é…ç½®è¯­æ³•"
    log_warn "ç„¶åè¿è¡Œ 'frp reload' é‡æ–°åŠ è½½é…ç½®"

    # å¤‡ä»½åŸé…ç½®
    local backup_file="$CONFIG_FILE.backup.$(date +%Y%m%d_%H%M%S)"
    cp "$CONFIG_FILE" "$backup_file"
    log_info "å·²å¤‡ä»½åŸé…ç½®åˆ°: $backup_file"

    # æ‰“å¼€ç¼–è¾‘å™¨
    $editor_found "$CONFIG_FILE"

    # æ£€æŸ¥é…ç½®æ˜¯å¦æœ‰å˜åŒ–
    if ! diff "$CONFIG_FILE" "$backup_file" >/dev/null 2>&1; then
        log_success "é…ç½®æ–‡ä»¶å·²ä¿®æ”¹"
        echo
        log_info "å»ºè®®æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:"
        echo "  frp test     # æµ‹è¯•é…ç½®è¯­æ³•"
        echo "  frp reload   # é‡æ–°åŠ è½½é…ç½®"
    else
        log_info "é…ç½®æ–‡ä»¶æœªä¿®æ”¹"
        rm -f "$backup_file"
    fi
}

# æµ‹è¯•é…ç½®
cmd_test() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        log_error "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
        return
    fi

    log_info "æµ‹è¯• FRP é…ç½®è¯­æ³•..."

    # æ£€æŸ¥TOMLè¯­æ³•
    if command -v python3 >/dev/null 2>&1; then
        # ä½¿ç”¨pythonæ£€æŸ¥TOMLè¯­æ³•
        if python3 -c "import tomllib; tomllib.load(open('$CONFIG_FILE', 'rb'))" 2>/dev/null; then
            log_success "TOML è¯­æ³•æ£€æŸ¥é€šè¿‡"
        else
            log_error "TOML è¯­æ³•é”™è¯¯"
            return 1
        fi
    elif command -v python >/dev/null 2>&1; then
        if python -c "import tomllib; tomllib.load(open('$CONFIG_FILE', 'rb'))" 2>/dev/null; then
            log_success "TOML è¯­æ³•æ£€æŸ¥é€šè¿‡"
        else
            log_error "TOML è¯­æ³•é”™è¯¯"
            return 1
        fi
    else
        log_warn "æ— æ³•æ£€æŸ¥ TOML è¯­æ³• (éœ€è¦ python3)"
    fi

    # ä½¿ç”¨FRPè‡ªèº«æµ‹è¯•é…ç½®
    if [[ -x "$EXECUTABLE" ]]; then
        log_info "ä½¿ç”¨ FRP ç¨‹åºéªŒè¯é…ç½®..."
        if "$EXECUTABLE" -c "$CONFIG_FILE" --test 2>/dev/null; then
            log_success "FRP é…ç½®éªŒè¯é€šè¿‡"
            return 0
        else
            log_error "FRP é…ç½®éªŒè¯å¤±è´¥"
            return 1
        fi
    else
        log_error "FRP å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: $EXECUTABLE"
        return 1
    fi
}

# é‡æ–°åŠ è½½é…ç½®
cmd_reload() {
    check_root "reload"

    if ! systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
        log_warn "FRP æœåŠ¡æœªè¿è¡Œï¼Œæ— æ³•é‡æ–°åŠ è½½é…ç½®"
        log_info "è¯·å…ˆå¯åŠ¨æœåŠ¡: frp start"
        return
    fi

    log_info "é‡æ–°åŠ è½½ FRP é…ç½®..."

    # å…ˆæµ‹è¯•é…ç½®
    if ! cmd_test >/dev/null 2>&1; then
        log_error "é…ç½®æµ‹è¯•å¤±è´¥ï¼Œä¸è¿›è¡Œé‡æ–°åŠ è½½"
        return 1
    fi

    # å‘é€HUPä¿¡å·é‡æ–°åŠ è½½é…ç½®
    if pkill -HUP -f "$EXECUTABLE" 2>/dev/null; then
        log_success "FRP é…ç½®é‡æ–°åŠ è½½æˆåŠŸ"
        sleep 2
        log_info "é…ç½®å·²ç”Ÿæ•ˆ"
    else
        log_error "é…ç½®é‡æ–°åŠ è½½å¤±è´¥"
        log_info "å°è¯•é‡å¯æœåŠ¡: frp restart"
        return 1
    fi
}

# æŸ¥çœ‹æ—¥å¿—
cmd_logs() {
    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        FRP å®æ—¶æ—¥å¿—${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo
    echo -e "${YELLOW}æŒ‰ Ctrl+C é€€å‡ºæ—¥å¿—æŸ¥çœ‹${NC}"
    echo

    # æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
    local log_file="$LOG_DIR/${SERVICE_NAME}.log"
    if [[ -f "$log_file" ]]; then
        log_info "æ­£åœ¨ç›‘æ§æ—¥å¿—æ–‡ä»¶: $log_file"
        echo
        tail -f "$log_file"
    else
        log_warn "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $log_file"
        log_info "å°è¯•æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—..."
        echo
        journalctl -u "$SERVICE_NAME" -f 2>/dev/null || log_error "æ— æ³•æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—"
    fi
}

# æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
cmd_logf() {
    local log_file="$LOG_DIR/${SERVICE_NAME}.log"

    if [[ ! -f "$log_file" ]]; then
        log_error "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $log_file"
        return
    fi

    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        FRP æ—¥å¿—æ–‡ä»¶${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo
    echo -e "${YELLOW}æ–‡ä»¶ä½ç½®: $log_file${NC}"
    echo -e "${YELLOW}æ–‡ä»¶å¤§å°: $(ls -lh "$log_file" | awk '{print $5}')${NC}"
    echo

    # æ˜¾ç¤ºæ—¥å¿—å†…å®¹
    if [[ -s "$log_file" ]]; then
        echo -e "${CYAN}æ—¥å¿—å†…å®¹ (æœ€å 50 è¡Œ):${NC}"
        echo
        tail -50 "$log_file"
    else
        echo "æ—¥å¿—æ–‡ä»¶ä¸ºç©º"
    fi
    echo
}

# å¤‡ä»½é…ç½®
cmd_backup() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_file="$CONFIG_DIR/${SERVICE_NAME}.toml.backup.$timestamp"

    if [[ ! -f "$CONFIG_FILE" ]]; then
        log_error "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
        return
    fi

    cp "$CONFIG_FILE" "$backup_file"
    log_success "é…ç½®å·²å¤‡ä»½åˆ°: $backup_file"

    # æ˜¾ç¤ºå¤‡ä»½æ–‡ä»¶åˆ—è¡¨
    echo
    echo -e "${CYAN}ç°æœ‰å¤‡ä»½æ–‡ä»¶:${NC}"
    ls -la "$CONFIG_DIR"/*.backup.* 2>/dev/null | while read -r line; do
        echo "  $line"
    done
}

# æ¢å¤é…ç½®
cmd_restore() {
    echo
    echo -e "${CYAN}å¯ç”¨çš„å¤‡ä»½æ–‡ä»¶:${NC}"
    echo

    local backups=()
    local i=1

    while IFS= read -r -d '' file; do
        backups+=("$file")
        echo "  $i) $(basename "$file") ($(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null) bytes)"
        ((i++))
    done < <(find "$CONFIG_DIR" -name "*.backup.*" -print0 2>/dev/null | sort -z)

    if [[ ${#backups[@]} -eq 0 ]]; then
        log_error "æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
        return
    fi

    echo
    read -p "é€‰æ‹©è¦æ¢å¤çš„å¤‡ä»½æ–‡ä»¶ç¼–å· (1-${#backups[@]}): " choice

    if [[ ! "$choice" =~ ^[0-9]+$ ]] || [[ $choice -lt 1 ]] || [[ $choice -gt ${#backups[@]} ]]; then
        log_error "æ— æ•ˆé€‰æ‹©"
        return
    fi

    local selected_backup="${backups[$((choice-1))]}"

    # å¤‡ä»½å½“å‰é…ç½®
    cmd_backup >/dev/null 2>&1

    # æ¢å¤å¤‡ä»½
    cp "$selected_backup" "$CONFIG_FILE"
    log_success "é…ç½®å·²ä»å¤‡ä»½æ¢å¤: $(basename "$selected_backup")"
    log_warn "å»ºè®®è¿è¡Œ 'frp test' æ£€æŸ¥é…ç½®ï¼Œç„¶å 'frp reload' é‡æ–°åŠ è½½"
}

# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
cmd_version() {
    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        FRP ç‰ˆæœ¬ä¿¡æ¯${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo
    echo "FRP ç‰ˆæœ¬: $FRP_VERSION"
    echo "ç®¡ç†è„šæœ¬: v1.0"
    echo "å®‰è£…ç›®å½•: $INSTALL_DIR"
    echo "é…ç½®ç›®å½•: $CONFIG_DIR"
    echo "æ—¥å¿—ç›®å½•: $LOG_DIR"
    echo

    # æ˜¾ç¤ºFRPç¨‹åºç‰ˆæœ¬
    if [[ -x "$EXECUTABLE" ]]; then
        echo -e "${CYAN}FRP ç¨‹åºç‰ˆæœ¬:${NC}"
        "$EXECUTABLE" --version 2>/dev/null || echo "æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯"
        echo
    fi
}

# æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
cmd_info() {
    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        ç³»ç»Ÿä¿¡æ¯${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo
    echo -e "${CYAN}æ“ä½œç³»ç»Ÿ:${NC}"
    echo "  ç³»ç»Ÿ: $(uname -s) $(uname -r)"
    echo "  æ¶æ„: $(uname -m)"
    echo

    echo -e "${CYAN}FRP å®‰è£…ä¿¡æ¯:${NC}"
    echo "  ç±»å‹: FRP $FRP_TYPE"
    echo "  æœåŠ¡: $SERVICE_NAME"
    echo "  ç‰ˆæœ¬: $FRP_VERSION"
    echo "  å®‰è£…ç›®å½•: $INSTALL_DIR"
    echo "  é…ç½®ç›®å½•: $CONFIG_DIR"
    echo "  æ—¥å¿—ç›®å½•: $LOG_DIR"
    echo

    echo -e "${CYAN}æ–‡ä»¶çŠ¶æ€:${NC}"
    echo "  å¯æ‰§è¡Œæ–‡ä»¶: $([[ -x "$EXECUTABLE" ]] && echo "âœ“ å­˜åœ¨" || echo "âœ— ä¸å­˜åœ¨")"
    echo "  é…ç½®æ–‡ä»¶: $([[ -f "$CONFIG_FILE" ]] && echo "âœ“ å­˜åœ¨" || echo "âœ— ä¸å­˜åœ¨")"
    echo "  æœåŠ¡æ–‡ä»¶: $([[ -f "/etc/systemd/system/${SERVICE_NAME}.service" ]] && echo "âœ“ å­˜åœ¨" || echo "âœ— ä¸å­˜åœ¨")"
    echo

    echo -e "${CYAN}ç£ç›˜ä½¿ç”¨:${NC}"
    echo "  å®‰è£…ç›®å½•: $(df -h "$INSTALL_DIR" 2>/dev/null | tail -1 | awk '{print $3"/"$2" ("$5" used)"}' || echo "æœªçŸ¥")"
    echo "  é…ç½®ç›®å½•: $(df -h "$CONFIG_DIR" 2>/dev/null | tail -1 | awk '{print $3"/"$2" ("$5" used)"}' || echo "æœªçŸ¥")"
    echo "  æ—¥å¿—ç›®å½•: $(df -h "$LOG_DIR" 2>/dev/null | tail -1 | awk '{print $3"/"$2" ("$5" used)"}' || echo "æœªçŸ¥")"
    echo
}

# æ˜¾ç¤ºè¿æ¥ä¿¡æ¯ (ä»…æœåŠ¡ç«¯)
cmd_connections() {
    if [[ "$FRP_TYPE" != "server" ]]; then
        log_error "æ­¤å‘½ä»¤ä»…é€‚ç”¨äº FRP æœåŠ¡ç«¯"
        return
    fi

    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        FRP è¿æ¥ä¿¡æ¯${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo

    # æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
    if ! systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
        log_warn "FRP æœåŠ¡æœªè¿è¡Œï¼Œæ— æ³•è·å–è¿æ¥ä¿¡æ¯"
        return
    fi

    # è·å–ç›‘å¬ç«¯å£
    local bind_port=$(grep "^bindPort" "$CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
    if [[ -n "$bind_port" ]]; then
        echo -e "${CYAN}æœåŠ¡ç«¯ç›‘å¬ç«¯å£: $bind_port${NC}"
        echo

        # æ˜¾ç¤ºè¿æ¥ç»Ÿè®¡
        echo -e "${CYAN}ç½‘ç»œè¿æ¥ç»Ÿè®¡:${NC}"
        if command -v netstat >/dev/null 2>&1; then
            local connections=$(netstat -ant 2>/dev/null | grep ":$bind_port" | grep ESTABLISHED | wc -l)
            echo "  å½“å‰è¿æ¥æ•°: $connections"
        fi

        if command -v ss >/dev/null 2>&1; then
            local tcp_connections=$(ss -ant 2>/dev/null | grep ":$bind_port" | grep ESTABLISHED | wc -l)
            echo "  TCP è¿æ¥æ•°: $tcp_connections"
        fi
    fi

    # æ˜¾ç¤ºä»£ç†ç»Ÿè®¡ (å¦‚æœæœ‰ç®¡ç†é¢æ¿)
    local dashboard_port=$(grep "^webServer.port" "$CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
    if [[ -n "$dashboard_port" ]]; then
        echo
        echo -e "${CYAN}ç®¡ç†é¢æ¿:${NC}"
        echo "  é¢æ¿åœ°å€: http://localhost:$dashboard_port"
        echo "  å»ºè®®é€šè¿‡æµè§ˆå™¨è®¿é—®æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯"
    fi
    echo
}

# æ£€æŸ¥æ˜¯å¦ä¸ºå®¢æˆ·ç«¯
check_is_client() {
    if [[ "$FRP_TYPE" != "client" ]]; then
        log_error "æ­¤å‘½ä»¤ä»…é€‚ç”¨äº FRP å®¢æˆ·ç«¯ (frpc)"
        return 1
    fi
    return 0
}

# è§£æä»£ç†è§„åˆ™åˆ—è¡¨
parse_proxy_list() {
    local config_file="$CONFIG_FILE"
    local in_proxy=false
    local proxy_name=""
    local proxy_type=""
    local local_ip=""
    local local_port=""
    local remote_port=""
    local custom_domain=""

    while IFS= read -r line || [[ -n "$line" ]]; do
        # å»é™¤å‰åç©ºæ ¼
        line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        
        # æ£€æµ‹ä»£ç†å—å¼€å§‹
        if [[ "$line" =~ ^\[\[proxies\]\] ]]; then
            # å¦‚æœä¹‹å‰æœ‰ä»£ç†ï¼Œå…ˆè¾“å‡º
            if [[ "$in_proxy" == true ]] && [[ -n "$proxy_name" ]]; then
                local info="${local_ip}:${local_port}"
                if [[ -n "$custom_domain" ]]; then
                    info="${info} -> ${custom_domain}"
                elif [[ -n "$remote_port" ]]; then
                    info="${info} -> ${remote_port}"
                fi
                echo "$proxy_name|$proxy_type|$info"
            fi
            in_proxy=true
            proxy_name=""
            proxy_type=""
            local_ip=""
            local_port=""
            remote_port=""
            custom_domain=""
        elif [[ "$in_proxy" == true ]]; then
            # æå–ä»£ç†åç§°
            if [[ "$line" =~ ^name[[:space:]]*=[[:space:]]*\"([^\"]+)\" ]]; then
                proxy_name="${BASH_REMATCH[1]}"
            fi
            # æå–ä»£ç†ç±»å‹
            if [[ "$line" =~ ^type[[:space:]]*=[[:space:]]*\"([^\"]+)\" ]]; then
                proxy_type="${BASH_REMATCH[1]}"
            fi
            # æå–æœ¬åœ°IP
            if [[ "$line" =~ ^localIP[[:space:]]*=[[:space:]]*\"([^\"]+)\" ]]; then
                local_ip="${BASH_REMATCH[1]}"
            fi
            # æå–æœ¬åœ°ç«¯å£
            if [[ "$line" =~ ^localPort[[:space:]]*=[[:space:]]*([0-9]+) ]]; then
                local_port="${BASH_REMATCH[1]}"
            fi
            # æå–è¿œç¨‹ç«¯å£
            if [[ "$line" =~ ^remotePort[[:space:]]*=[[:space:]]*([0-9]+) ]]; then
                remote_port="${BASH_REMATCH[1]}"
            fi
            # æå–è‡ªå®šä¹‰åŸŸå
            if [[ "$line" =~ ^customDomains[[:space:]]*=[[:space:]]*\[.*\"([^\"]+)\".*\] ]]; then
                custom_domain="${BASH_REMATCH[1]}"
            fi
            # æ£€æµ‹ä»£ç†å—ç»“æŸï¼ˆç©ºè¡Œä¸”å·²æœ‰ä»£ç†ä¿¡æ¯ï¼‰
            if [[ -z "$line" ]] && [[ -n "$proxy_name" ]]; then
                local info="${local_ip}:${local_port}"
                if [[ -n "$custom_domain" ]]; then
                    info="${info} -> ${custom_domain}"
                elif [[ -n "$remote_port" ]]; then
                    info="${info} -> ${remote_port}"
                fi
                echo "$proxy_name|$proxy_type|$info"
                in_proxy=false
            fi
        fi
    done < "$config_file"
    
    # å¤„ç†æœ€åä¸€ä¸ªä»£ç†ï¼ˆå¦‚æœæ–‡ä»¶æœ«å°¾æ²¡æœ‰ç©ºè¡Œï¼‰
    if [[ "$in_proxy" == true ]] && [[ -n "$proxy_name" ]]; then
        local info="${local_ip}:${local_port}"
        if [[ -n "$custom_domain" ]]; then
            info="${info} -> ${custom_domain}"
        elif [[ -n "$remote_port" ]]; then
            info="${info} -> ${remote_port}"
        fi
        echo "$proxy_name|$proxy_type|$info"
    fi
}

# åˆ—å‡ºæ‰€æœ‰ä»£ç†è§„åˆ™
cmd_proxy_list() {
    if ! check_is_client; then
        return 1
    fi

    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        ä»£ç†è§„åˆ™åˆ—è¡¨${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo

    local proxies=$(parse_proxy_list)
    local count=0

    if [[ -z "$proxies" ]]; then
        log_warn "æœªæ‰¾åˆ°ä»»ä½•ä»£ç†è§„åˆ™"
        echo
        log_info "ä½¿ç”¨ 'frp proxy add' æ·»åŠ æ–°çš„ä»£ç†è§„åˆ™"
        return
    fi

    echo -e "${CYAN}ä»£ç†è§„åˆ™:${NC}"
    echo

    # å°†ä»£ç†è§„åˆ™å­˜å‚¨åˆ°æ•°ç»„ä¸­
    local proxy_array=()
    while IFS='|' read -r name type info; do
        ((count++))
        proxy_array+=("$name|$type|$info")
    done <<< "$proxies"

    # è®¡ç®—ç»ˆç«¯å®½åº¦ï¼ˆé»˜è®¤80ï¼‰
    local term_width=${COLUMNS:-80}
    local col_width=$((term_width / 2 - 5))
    
    # ä¸€è¡Œæ˜¾ç¤ºä¸¤ä¸ªä»£ç†è§„åˆ™
    local i=0
    while [[ $i -lt ${#proxy_array[@]} ]]; do
        local proxy1="${proxy_array[$i]}"
        local proxy2="${proxy_array[$((i+1))]}"
        
        if [[ -n "$proxy2" ]]; then
            # ä¸¤ä¸ªä»£ç†è§„åˆ™
            IFS='|' read -r name1 type1 info1 <<< "$proxy1"
            IFS='|' read -r name2 type2 info2 <<< "$proxy2"
            
            # æˆªæ–­è¿‡é•¿çš„ä¿¡æ¯
            local info1_short="${info1:0:$((col_width-15))}"
            local info2_short="${info2:0:$((col_width-15))}"
            [[ ${#info1} -gt $((col_width-15)) ]] && info1_short="${info1_short}..."
            [[ ${#info2} -gt $((col_width-15)) ]] && info2_short="${info2_short}..."
            
            printf "  [%2d] %-12s %-6s %-${col_width}s  [%2d] %-12s %-6s %s\n" \
                $((i+1)) "$name1" "$type1" "$info1_short" \
                $((i+2)) "$name2" "$type2" "$info2_short"
            i=$((i+2))
        else
            # æœ€åä¸€ä¸ªä»£ç†è§„åˆ™
            IFS='|' read -r name1 type1 info1 <<< "$proxy1"
            local info1_short="${info1:0:$((col_width-15))}"
            [[ ${#info1} -gt $((col_width-15)) ]] && info1_short="${info1_short}..."
            printf "  [%2d] %-12s %-6s %s\n" $((i+1)) "$name1" "$type1" "$info1_short"
            i=$((i+1))
        fi
    done

    echo
    echo -e "${CYAN}æ€»è®¡: $count ä¸ªä»£ç†è§„åˆ™${NC}"
    echo
}

# æ˜¾ç¤ºä»£ç†è§„åˆ™è¯¦æƒ…
cmd_proxy_show() {
    if ! check_is_client; then
        return 1
    fi

    local proxy_name="$1"

    if [[ -z "$proxy_name" ]]; then
        log_error "è¯·æŒ‡å®šä»£ç†è§„åˆ™åç§°"
        log_info "ä½¿ç”¨ 'frp proxy list' æŸ¥çœ‹æ‰€æœ‰ä»£ç†è§„åˆ™"
        return 1
    fi

    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        ä»£ç†è§„åˆ™è¯¦æƒ…${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo

    # æå–ä»£ç†è§„åˆ™é…ç½® - ä½¿ç”¨ä¸€æ¬¡éå†
    local found=false
    local proxy_lines=()
    local current_block=()
    local in_proxy_block=false
    local is_target_proxy=false
    
    while IFS= read -r line || [[ -n "$line" ]]; do
        # æ£€æµ‹ä»£ç†å—å¼€å§‹
        if [[ "$line" =~ ^\[\[proxies\]\] ]]; then
            # å¦‚æœä¹‹å‰æ‰¾åˆ°äº†ç›®æ ‡ä»£ç†ï¼Œé€€å‡º
            if [[ "$found" == true ]]; then
                break
            fi
            # å¼€å§‹æ–°çš„ä»£ç†å—
            in_proxy_block=true
            is_target_proxy=false
            current_block=("$line")
        elif [[ "$in_proxy_block" == true ]]; then
            # åœ¨ä»£ç†å—ä¸­
            current_block+=("$line")
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯ç›®æ ‡ä»£ç†çš„åç§°
            if [[ "$line" =~ ^name[[:space:]]*=[[:space:]]*\"$proxy_name\" ]]; then
                is_target_proxy=true
                found=true
                proxy_lines=("${current_block[@]}")
            fi
            
            # æ£€æµ‹ä»£ç†å—ç»“æŸï¼ˆç©ºè¡Œï¼‰
            if [[ -z "$line" ]] || [[ "$line" =~ ^[[:space:]]*$ ]]; then
                # å¦‚æœè¿™æ˜¯ç›®æ ‡ä»£ç†ï¼Œä¿å­˜å¹¶é€€å‡º
                if [[ "$is_target_proxy" == true ]] && [[ "$found" == true ]]; then
                    proxy_lines=("${current_block[@]}")
                    break
                fi
                # å¦åˆ™é‡ç½®çŠ¶æ€ï¼Œå‡†å¤‡ä¸‹ä¸€ä¸ªä»£ç†å—
                in_proxy_block=false
                is_target_proxy=false
                current_block=()
            fi
        fi
    done < "$CONFIG_FILE"
    
    # å¤„ç†æ–‡ä»¶æœ«å°¾æ²¡æœ‰ç©ºè¡Œçš„æƒ…å†µ
    if [[ "$found" == false ]] && [[ "$in_proxy_block" == true ]] && [[ ${#current_block[@]} -gt 0 ]]; then
        # æ£€æŸ¥æœ€åä¸€ä¸ªä»£ç†å—
        for line in "${current_block[@]}"; do
            if [[ "$line" =~ ^name[[:space:]]*=[[:space:]]*\"$proxy_name\" ]]; then
                found=true
                proxy_lines=("${current_block[@]}")
                break
            fi
        done
    fi
    
    if [[ "$found" == false ]] || [[ ${#proxy_lines[@]} -eq 0 ]]; then
        log_error "æœªæ‰¾åˆ°ä»£ç†è§„åˆ™: $proxy_name"
        log_info "è¯·æ£€æŸ¥ä»£ç†è§„åˆ™åç§°æ˜¯å¦æ­£ç¡®"
        log_info "ä½¿ç”¨ 'frp proxy list' æŸ¥çœ‹æ‰€æœ‰ä»£ç†è§„åˆ™"
        return 1
    fi

    echo -e "${CYAN}ä»£ç†è§„åˆ™é…ç½®:${NC}"
    echo
    for line in "${proxy_lines[@]}"; do
        echo "$line"
    done
    echo
}

# æ·»åŠ ä»£ç†è§„åˆ™
cmd_proxy_add() {
    if ! check_is_client; then
        return 1
    fi

    check_root "proxy add"

    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        æ·»åŠ ä»£ç†è§„åˆ™${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo

    # è·å–ä»£ç†è§„åˆ™ä¿¡æ¯
    read -p "è¯·è¾“å…¥ä»£ç†åç§°: " proxy_name
    if [[ -z "$proxy_name" ]]; then
        log_error "ä»£ç†åç§°ä¸èƒ½ä¸ºç©º"
        return 1
    fi

    # æ£€æŸ¥åç§°æ˜¯å¦å·²å­˜åœ¨
    if grep -q "name = \"$proxy_name\"" "$CONFIG_FILE" 2>/dev/null; then
        log_error "ä»£ç†è§„åˆ™ '$proxy_name' å·²å­˜åœ¨"
        return 1
    fi

    read -p "è¯·è¾“å…¥ä»£ç†ç±»å‹ [tcp/http] [é»˜è®¤tcp]: " proxy_type
    proxy_type=${proxy_type:-tcp}

    if [[ "$proxy_type" != "tcp" ]] && [[ "$proxy_type" != "http" ]]; then
        log_error "ä¸æ”¯æŒçš„ä»£ç†ç±»å‹: $proxy_type"
        return 1
    fi

    read -p "è¯·è¾“å…¥æœ¬åœ°IPåœ°å€ [é»˜è®¤127.0.0.1]: " local_ip
    local_ip=${local_ip:-127.0.0.1}

    read -p "è¯·è¾“å…¥æœ¬åœ°ç«¯å£: " local_port
    if [[ -z "$local_port" ]]; then
        log_error "æœ¬åœ°ç«¯å£ä¸èƒ½ä¸ºç©º"
        return 1
    fi

    # å¤‡ä»½é…ç½®
    cmd_backup >/dev/null 2>&1

    # æ·»åŠ ä»£ç†è§„åˆ™åˆ°é…ç½®æ–‡ä»¶
    {
        echo ""
        echo "# ä»£ç†è§„åˆ™: $proxy_name"
        echo "[[proxies]]"
        echo "name = \"$proxy_name\""
        echo "type = \"$proxy_type\""
        echo "localIP = \"$local_ip\""
        echo "localPort = $local_port"
    } >> "$CONFIG_FILE"

    if [[ "$proxy_type" == "tcp" ]]; then
        read -p "è¯·è¾“å…¥è¿œç¨‹ç«¯å£: " remote_port
        if [[ -z "$remote_port" ]]; then
            log_error "è¿œç¨‹ç«¯å£ä¸èƒ½ä¸ºç©º"
            return 1
        fi
        echo "remotePort = $remote_port" >> "$CONFIG_FILE"
    else  # http
        read -p "è¯·è¾“å…¥è‡ªå®šä¹‰åŸŸå [ç•™ç©ºä½¿ç”¨ç«¯å£]: " custom_domain
        if [[ -n "$custom_domain" ]]; then
            echo "customDomains = [\"$custom_domain\"]" >> "$CONFIG_FILE"
        else
            read -p "è¯·è¾“å…¥è¿œç¨‹ç«¯å£: " remote_port
            if [[ -z "$remote_port" ]]; then
                log_error "è¿œç¨‹ç«¯å£ä¸èƒ½ä¸ºç©º"
                return 1
            fi
            echo "remotePort = $remote_port" >> "$CONFIG_FILE"
        fi
    fi

    echo "" >> "$CONFIG_FILE"

    log_success "ä»£ç†è§„åˆ™ '$proxy_name' å·²æ·»åŠ "
    echo
    log_info "å»ºè®®æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:"
    echo "  frp test     # æµ‹è¯•é…ç½®è¯­æ³•"
    echo "  frp reload   # é‡æ–°åŠ è½½é…ç½®"
}

# åˆ é™¤ä»£ç†è§„åˆ™
cmd_proxy_delete() {
    if ! check_is_client; then
        return 1
    fi

    check_root "proxy delete"

    local proxy_name="$1"

    if [[ -z "$proxy_name" ]]; then
        log_error "è¯·æŒ‡å®šè¦åˆ é™¤çš„ä»£ç†è§„åˆ™åç§°"
        log_info "ä½¿ç”¨ 'frp proxy list' æŸ¥çœ‹æ‰€æœ‰ä»£ç†è§„åˆ™"
        return 1
    fi

    # æ£€æŸ¥ä»£ç†æ˜¯å¦å­˜åœ¨
    if ! grep -q "name = \"$proxy_name\"" "$CONFIG_FILE" 2>/dev/null; then
        log_error "ä»£ç†è§„åˆ™ '$proxy_name' ä¸å­˜åœ¨"
        return 1
    fi

    echo
    read -p "ç¡®è®¤è¦åˆ é™¤ä»£ç†è§„åˆ™ '$proxy_name' å—? (y/N): " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        log_info "åˆ é™¤å·²å–æ¶ˆ"
        return
    fi

    # å¤‡ä»½é…ç½®
    cmd_backup >/dev/null 2>&1

    # ä½¿ç”¨ Python åˆ é™¤ä»£ç†è§„åˆ™ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if command -v python3 >/dev/null 2>&1; then
        python3 << PYEOF
import re
import sys

config_file = "$CONFIG_FILE"
proxy_name = "$proxy_name"

try:
    with open(config_file, 'r', encoding='utf-8') as f:
        lines = f.readlines()
    
    new_lines = []
    skip_block = False
    proxy_found = False
    
    i = 0
    while i < len(lines):
        line = lines[i]
        
        # æ£€æµ‹ä»£ç†å—å¼€å§‹
        if re.match(r'^\s*\[\[proxies\]\]', line):
            # æ£€æŸ¥ä¸‹ä¸€ä¸ªä»£ç†çš„åç§°
            skip_block = False
            block_start = i
            i += 1
            
            # è¯»å–ä»£ç†å—ç›´åˆ°ç©ºè¡Œæˆ–ä¸‹ä¸€ä¸ªä»£ç†å—
            while i < len(lines):
                if re.match(r'^\s*name\s*=\s*"{}"'.format(re.escape(proxy_name)), lines[i]):
                    skip_block = True
                    proxy_found = True
                    # è·³è¿‡æ•´ä¸ªä»£ç†å—ç›´åˆ°ç©ºè¡Œ
                    while i < len(lines) and lines[i].strip():
                        i += 1
                    # è·³è¿‡ç©ºè¡Œ
                    if i < len(lines) and not lines[i].strip():
                        i += 1
                    break
                elif re.match(r'^\s*\[\[proxies\]\]', lines[i]):
                    # é‡åˆ°ä¸‹ä¸€ä¸ªä»£ç†å—ï¼Œåœæ­¢
                    break
                elif not lines[i].strip() and i > block_start + 1:
                    # é‡åˆ°ç©ºè¡Œï¼Œè¿™ä¸ªä»£ç†å—ç»“æŸ
                    if not skip_block:
                        # ä¿ç•™è¿™ä¸ªä»£ç†å—
                        for j in range(block_start, i + 1):
                            new_lines.append(lines[j])
                    i += 1
                    break
                i += 1
        else:
            if not skip_block:
                new_lines.append(line)
            i += 1
    
    if not proxy_found:
        print("ERROR: ä»£ç†è§„åˆ™æœªæ‰¾åˆ°", file=sys.stderr)
        exit(1)
    
    # æ¸…ç†å¤šä½™çš„ç©ºè¡Œ
    content = ''.join(new_lines)
    content = re.sub(r'\n{3,}', '\n\n', content)
    
    with open(config_file, 'w', encoding='utf-8') as f:
        f.write(content)
    
except Exception as e:
    print(f"ERROR: {e}", file=sys.stderr)
    exit(1)
PYEOF
        if [[ $? -eq 0 ]]; then
            log_success "ä»£ç†è§„åˆ™ '$proxy_name' å·²åˆ é™¤"
            echo
            log_info "å»ºè®®æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:"
            echo "  frp test     # æµ‹è¯•é…ç½®è¯­æ³•"
            echo "  frp reload   # é‡æ–°åŠ è½½é…ç½®"
            return 0
        else
            log_error "åˆ é™¤ä»£ç†è§„åˆ™å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç¼–è¾‘é…ç½®æ–‡ä»¶"
            return 1
        fi
    else
        log_error "éœ€è¦ python3 æ¥åˆ é™¤ä»£ç†è§„åˆ™"
        log_info "è¯·æ‰‹åŠ¨ç¼–è¾‘é…ç½®æ–‡ä»¶: $CONFIG_FILE"
        log_info "æˆ–å®‰è£… python3 åé‡è¯•"
        return 1
    fi

    log_success "ä»£ç†è§„åˆ™ '$proxy_name' å·²åˆ é™¤"
    echo
    log_info "å»ºè®®æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:"
    echo "  frp test     # æµ‹è¯•é…ç½®è¯­æ³•"
    echo "  frp reload   # é‡æ–°åŠ è½½é…ç½®"
}

# ç¼–è¾‘ä»£ç†è§„åˆ™
cmd_proxy_edit() {
    if ! check_is_client; then
        return 1
    fi

    check_root "proxy edit"

    local proxy_name="$1"

    if [[ -z "$proxy_name" ]]; then
        log_error "è¯·æŒ‡å®šè¦ç¼–è¾‘çš„ä»£ç†è§„åˆ™åç§°"
        log_info "ä½¿ç”¨ 'frp proxy list' æŸ¥çœ‹æ‰€æœ‰ä»£ç†è§„åˆ™"
        return 1
    fi

    # æ˜¾ç¤ºå½“å‰é…ç½®
    cmd_proxy_show "$proxy_name"

    echo
    log_info "ç¼–è¾‘ä»£ç†è§„åˆ™: $proxy_name"
    log_warn "å»ºè®®å…ˆåˆ é™¤æ—§è§„åˆ™ï¼Œç„¶åä½¿ç”¨ 'frp proxy add' æ·»åŠ æ–°è§„åˆ™"
    echo
    read -p "æ˜¯å¦ç»§ç»­ç¼–è¾‘? (y/N): " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        log_info "ç¼–è¾‘å·²å–æ¶ˆ"
        return
    fi

    # åˆ é™¤æ—§è§„åˆ™
    cmd_proxy_delete "$proxy_name" >/dev/null 2>&1

    # æ·»åŠ æ–°è§„åˆ™
    echo
    log_info "è¯·é‡æ–°è¾“å…¥ä»£ç†è§„åˆ™ä¿¡æ¯:"
    cmd_proxy_add
}

# ä»£ç†è§„åˆ™ç®¡ç†ä¸»å‡½æ•°
cmd_proxy() {
    local subcommand="$1"
    local proxy_name="$2"

    case "$subcommand" in
        list)
            cmd_proxy_list
            ;;
        add)
            cmd_proxy_add
            ;;
        delete|del|remove|rm)
            cmd_proxy_delete "$proxy_name"
            ;;
        edit)
            cmd_proxy_edit "$proxy_name"
            ;;
        show|info)
            cmd_proxy_show "$proxy_name"
            ;;
        *)
            log_error "æœªçŸ¥çš„ä»£ç†è§„åˆ™å‘½ä»¤: $subcommand"
            echo
            echo -e "${CYAN}å¯ç”¨çš„ä»£ç†è§„åˆ™å‘½ä»¤:${NC}"
            echo "  frp proxy list         åˆ—å‡ºæ‰€æœ‰ä»£ç†è§„åˆ™"
            echo "  frp proxy add          æ·»åŠ æ–°çš„ä»£ç†è§„åˆ™"
            echo "  frp proxy delete <åç§°> åˆ é™¤ä»£ç†è§„åˆ™"
            echo "  frp proxy edit <åç§°>   ç¼–è¾‘ä»£ç†è§„åˆ™"
            echo "  frp proxy show <åç§°>   æ˜¾ç¤ºä»£ç†è§„åˆ™è¯¦æƒ…"
            echo
            return 1
            ;;
    esac
}

# å¸è½½FRPï¼ˆæ”¯æŒä»…å¸è½½ frps / frpc æˆ–å…¨éƒ¨ï¼‰
cmd_uninstall() {
    check_root "uninstall"

    local target="$1"  # server / frps / client / frpc / all / ç©º

    # è§„èŒƒåŒ– target
    case "$target" in
        server|frps)
            target="server"
            ;;
        client|frpc)
            target="client"
            ;;
        ""|all)
            target="all"
            ;;
        *)
            log_error "æœªçŸ¥çš„å¸è½½ç›®æ ‡: $target"
            echo "æ”¯æŒ: server, client, all"
            return 1
            ;;
    esac

    echo
    echo -e "${RED}========================================${NC}"
    if [[ "$target" == "server" ]]; then
        echo -e "${RED}        å¸è½½ FRP æœåŠ¡å™¨ (frps)${NC}"
    elif [[ "$target" == "client" ]]; then
        echo -e "${RED}        å¸è½½ FRP å®¢æˆ·ç«¯ (frpc)${NC}"
    else
        echo -e "${RED}        å¸è½½ FRP (å…¨éƒ¨)${NC}"
    fi
    echo -e "${RED}========================================${NC}"
    echo

    if [[ "$target" == "all" ]]; then
        log_warn "æ­¤æ“ä½œå°†å®Œå…¨å¸è½½ FRP åŠå…¶æ‰€æœ‰é…ç½®å’Œæ—¥å¿—"
    else
        log_warn "æ­¤æ“ä½œå°†å¸è½½æŒ‡å®šç»„ä»¶çš„ systemd æœåŠ¡å’Œé…ç½®æ–‡ä»¶"
        log_warn "FRP äºŒè¿›åˆ¶æ–‡ä»¶å’Œå…¶ä»–ç»„ä»¶å°†ä¿ç•™"
    fi
    echo

    read -p "ç¡®è®¤è¦å¸è½½ ($target) å—? (y/N): " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        log_info "å¸è½½å·²å–æ¶ˆ"
        return
    fi

    # å¸è½½æœåŠ¡å™¨ç»„ä»¶
    if [[ "$target" == "server" || "$target" == "all" ]]; then
        local svc="frps"
        local cfg="$CONFIG_DIR/frps.toml"

        log_info "å¼€å§‹å¸è½½ FRP æœåŠ¡å™¨ (frps)..."

        if systemctl is-active --quiet "$svc" 2>/dev/null; then
            log_info "åœæ­¢æœåŠ¡ $svc..."
            systemctl stop "$svc" 2>/dev/null
            systemctl disable "$svc" 2>/dev/null || true
        fi

        if [[ -f "/etc/systemd/system/${svc}.service" ]]; then
            log_info "åˆ é™¤æœåŠ¡æ–‡ä»¶ /etc/systemd/system/${svc}.service..."
            rm -f "/etc/systemd/system/${svc}.service"
            systemctl daemon-reload || true
        fi

        if [[ -f "$cfg" ]]; then
            read -p "æ˜¯å¦åˆ é™¤æœåŠ¡å™¨é…ç½®æ–‡ä»¶ $cfg ? (y/N): " del_cfg_s
            if [[ "$del_cfg_s" =~ ^[Yy]$ ]]; then
                log_info "åˆ é™¤é…ç½®æ–‡ä»¶ $cfg..."
                rm -f "$cfg"
            fi
        fi

        log_success "FRP æœåŠ¡å™¨ (frps) å¸è½½å®Œæˆ"
        echo
    fi

    # å¸è½½å®¢æˆ·ç«¯ç»„ä»¶
    if [[ "$target" == "client" || "$target" == "all" ]]; then
        local svc="frpc"
        local cfg="$CONFIG_DIR/frpc.toml"

        log_info "å¼€å§‹å¸è½½ FRP å®¢æˆ·ç«¯ (frpc)..."

        if systemctl is-active --quiet "$svc" 2>/dev/null; then
            log_info "åœæ­¢æœåŠ¡ $svc..."
            systemctl stop "$svc" 2>/dev/null
            systemctl disable "$svc" 2>/dev/null || true
        fi

        if [[ -f "/etc/systemd/system/${svc}.service" ]]; then
            log_info "åˆ é™¤æœåŠ¡æ–‡ä»¶ /etc/systemd/system/${svc}.service..."
            rm -f "/etc/systemd/system/${svc}.service"
            systemctl daemon-reload || true
        fi

        if [[ -f "$cfg" ]]; then
            read -p "æ˜¯å¦åˆ é™¤å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ $cfg ? (y/N): " del_cfg_c
            if [[ "$del_cfg_c" =~ ^[Yy]$ ]]; then
                log_info "åˆ é™¤é…ç½®æ–‡ä»¶ $cfg..."
                rm -f "$cfg"
            fi
        fi

        log_success "FRP å®¢æˆ·ç«¯ (frpc) å¸è½½å®Œæˆ"
        echo
    fi

    # å¦‚æœæ˜¯å®Œæ•´å¸è½½ï¼Œå†æ¸…ç†å®‰è£…ç›®å½• / æ—¥å¿— / ç®¡ç†è„šæœ¬
    if [[ "$target" == "all" ]]; then
        # åˆ é™¤å®‰è£…ç›®å½•
        if [[ -d "$INSTALL_DIR" ]]; then
            log_info "åˆ é™¤å®‰è£…ç›®å½• $INSTALL_DIR..."
            rm -rf "$INSTALL_DIR"
        fi

        # åˆ é™¤é…ç½®ç›®å½•ï¼ˆå¦‚æœè¿˜æœ‰æ®‹ç•™ï¼‰
        if [[ -d "$CONFIG_DIR" ]]; then
            read -p "æ˜¯å¦åˆ é™¤é…ç½®æ–‡ä»¶ç›®å½• $CONFIG_DIR? (y/N): " del_config
            if [[ "$del_config" =~ ^[Yy]$ ]]; then
                log_info "åˆ é™¤é…ç½®ç›®å½•..."
                rm -rf "$CONFIG_DIR"
            fi
        fi

        # åˆ é™¤æ—¥å¿—ç›®å½•
        if [[ -d "$LOG_DIR" ]]; then
            read -p "æ˜¯å¦åˆ é™¤æ—¥å¿—ç›®å½• $LOG_DIR? (y/N): " del_logs
            if [[ "$del_logs" =~ ^[Yy]$ ]]; then
                log_info "åˆ é™¤æ—¥å¿—ç›®å½•..."
                rm -rf "$LOG_DIR"
            fi
        fi

        # åˆ é™¤ç®¡ç†è„šæœ¬
        if [[ -f "/usr/local/bin/frp" ]]; then
            read -p "æ˜¯å¦åˆ é™¤ç®¡ç†è„šæœ¬ /usr/local/bin/frp ? (y/N): " del_script
            if [[ "$del_script" =~ ^[Yy]$ ]]; then
                log_info "åˆ é™¤ç®¡ç†è„šæœ¬..."
                rm -f "/usr/local/bin/frp"
            fi
        fi

        log_success "FRP å·²å®Œå…¨å¸è½½"
        echo
        log_info "å¦‚æœéœ€è¦é‡æ–°å®‰è£…ï¼Œè¯·è¿è¡Œ: frp install server æˆ– frp install client"
    else
        log_success "ç›®æ ‡ç»„ä»¶ ($target) å¸è½½å®Œæˆ"
        echo
        log_info "å…¶ä»–ç»„ä»¶å¦‚ä»éœ€ä½¿ç”¨ï¼Œå¯ç»§ç»­é€šè¿‡ 'frp' å‘½ä»¤ç®¡ç†"
    fi
}

# ç›‘æ§æœåŠ¡çŠ¶æ€
cmd_monitor() {
    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        FRP æœåŠ¡ç›‘æ§${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo
    echo -e "${YELLOW}æŒ‰ Ctrl+C é€€å‡ºç›‘æ§${NC}"
    echo

    local interval=5
    local count=0

    while true; do
        ((count++))
        echo -e "${CYAN}=== ç›‘æ§æ•°æ® #$count ($(date '+%H:%M:%S')) ===${NC}"

        # æœåŠ¡çŠ¶æ€
        if systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
            echo -e "æœåŠ¡çŠ¶æ€: ${GREEN}è¿è¡Œä¸­${NC}"
        else
            echo -e "æœåŠ¡çŠ¶æ€: ${RED}æœªè¿è¡Œ${NC}"
        fi

        # è¿›ç¨‹ä¿¡æ¯
        local pid=$(pgrep -f "$EXECUTABLE" | head -1)
        if [[ -n "$pid" ]]; then
            local cpu=$(ps -p "$pid" -o pcpu= 2>/dev/null | tr -d ' ')
            local mem=$(ps -p "$pid" -o pmem= 2>/dev/null | tr -d ' ')
            echo "è¿›ç¨‹ID: $pid | CPU: ${cpu:-0}% | å†…å­˜: ${mem:-0}%"
        fi

        # è¿æ¥æ•° (æœåŠ¡ç«¯)
        if [[ "$FRP_TYPE" == "server" ]] && command -v netstat >/dev/null 2>&1; then
            local bind_port=$(grep "^bindPort" "$CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
            if [[ -n "$bind_port" ]]; then
                local connections=$(netstat -ant 2>/dev/null | grep ":$bind_port" | grep ESTABLISHED | wc -l)
                echo "å½“å‰è¿æ¥æ•°: $connections"
            fi
        fi

        # ç£ç›˜ä½¿ç”¨
        local log_size=$(du -sh "$LOG_DIR" 2>/dev/null | cut -f1)
        echo "æ—¥å¿—å¤§å°: ${log_size:-0}"

        echo
        sleep "$interval"
    done
}

# æ˜¾ç¤ºå®‰è£…èœå•
show_install_menu() {
    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        FRP å®‰è£…å‘å¯¼${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo
    echo -e "${YELLOW}è¯·é€‰æ‹©è¦å®‰è£…çš„ FRP ç»„ä»¶ï¼š${NC}"
    echo
    echo "  1) ğŸš€ å®‰è£… FRP æœåŠ¡å™¨ (frps)"
    echo "     ç”¨äºæ­å»º FRP æœåŠ¡ç«¯ï¼Œä¾›å®¢æˆ·ç«¯è¿æ¥"
    echo
    echo "  2) ğŸ’» å®‰è£… FRP å®¢æˆ·ç«¯ (frpc)"
    echo "     ç”¨äºè¿æ¥åˆ° FRP æœåŠ¡ç«¯ï¼Œæ˜ å°„æœ¬åœ°æœåŠ¡"
    echo
    echo "  0) âŒ å–æ¶ˆå®‰è£…"
    echo
    echo -e "${BLUE}========================================${NC}"
    echo
}

# å®‰è£…FRP
cmd_install() {
    local install_type="$1"

    if [[ "$install_type" != "server" ]] && [[ "$install_type" != "client" ]]; then
        show_install_menu
        read -p "è¯·è¾“å…¥é€‰æ‹© [0-2]: " choice

        case $choice in
            1)
                install_type="server"
                ;;
            2)
                install_type="client"
                ;;
            0)
                log_info "å®‰è£…å·²å–æ¶ˆ"
                exit 0
                ;;
            *)
                log_error "æ— æ•ˆé€‰æ‹©"
                exit 1
                ;;
        esac
    fi

    check_root "install"

    # æ£€æµ‹ç³»ç»Ÿä¿¡æ¯ï¼ˆä½¿ç”¨é™é»˜ç‰ˆæœ¬è·å–å¹²å‡€çš„æ¶æ„å­—ç¬¦ä¸²ï¼‰
    local os_arch=$(detect_os_arch_silent 2>&1)
    if [[ -z "$os_arch" ]] || [[ "$os_arch" == *"ERROR"* ]]; then
        log_error "ç³»ç»Ÿæ£€æµ‹å¤±è´¥"
        exit 1
    fi
    
    # æ˜¾ç¤ºè¯¦ç»†çš„ç³»ç»Ÿä¿¡æ¯ï¼ˆä½†ä¸æ•è·è¾“å‡ºï¼‰
    detect_os_arch >/dev/null 2>&1 || true
    log_info "æ£€æµ‹åˆ°ç³»ç»Ÿæ¶æ„: $os_arch"

    # ç³»ç»Ÿå…¼å®¹æ€§æ£€æŸ¥
    check_system_compatibility "$os_arch"

    # æŸ¥æ‰¾å®‰è£…åŒ…ï¼ˆé”™è¯¯ä¿¡æ¯ä¼šè¾“å‡ºåˆ° stderrï¼Œè·¯å¾„è¾“å‡ºåˆ° stdoutï¼‰
    # æ³¨æ„ï¼šfind_package åœ¨æ‰¾ä¸åˆ°åŒ…æ—¶ä¼š exit 1ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦æ£€æŸ¥è¿”å›å€¼
    local package_path=$(find_package "$os_arch")

    # åˆ›å»ºç›®å½•
    create_directories

    # è§£å‹å®‰è£…åŒ…
    extract_package "$package_path"

    # é…ç½®FRP
    if [[ "$install_type" == "server" ]]; then
        setup_frps
    else
        setup_frpc
    fi

    # å®‰è£…ç®¡ç†è„šæœ¬
    install_management_script

    echo
    log_success "FRP $install_type å®‰è£…å®Œæˆï¼"
    echo
    log_info "ç°åœ¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç®¡ç† FRP:"
    echo "  frp status    # æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  frp logs      # æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo "  frp edit      # ç¼–è¾‘é…ç½®æ–‡ä»¶"
    echo "  frp help      # æ˜¾ç¤ºæ‰€æœ‰å‘½ä»¤"
}

# å®‰è£…ç®¡ç†è„šæœ¬
install_management_script() {
    log_info "å®‰è£… FRP ç®¡ç†è„šæœ¬..."

    local script_target="/usr/local/bin/frp"

    # æ£€æŸ¥è„šæœ¬æ˜¯å¦å·²ç»åœ¨æ­£ç¡®ä½ç½®
    if [[ "$SCRIPT_DIR/frp" -ef "$script_target" ]]; then
        log_info "FRP ç®¡ç†è„šæœ¬å·²åœ¨æ­£ç¡®ä½ç½®"
        return
    fi

    # å¤åˆ¶è„šæœ¬åˆ°ç³»ç»Ÿè·¯å¾„
    if cp "$SCRIPT_DIR/frp" "$script_target" && chmod +x "$script_target"; then
        log_success "FRP ç®¡ç†è„šæœ¬å·²å®‰è£…åˆ°: $script_target"
    else
        log_error "ç®¡ç†è„šæœ¬å®‰è£…å¤±è´¥"
        log_info "ä½ å¯ä»¥æ‰‹åŠ¨å¤åˆ¶è„šæœ¬: cp $SCRIPT_DIR/frp $script_target && chmod +x $script_target"
    fi
}

# æ˜¾ç¤ºä¸»èœå•ï¼ˆå·²å®‰è£…çŠ¶æ€ï¼‰
show_main_menu() {
    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        FRP ç®¡ç†å·¥å…·ä¸»èœå•${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo
    echo -e "${CYAN}æœåŠ¡ç®¡ç†:${NC}"
    echo "  1) å¯åŠ¨æœåŠ¡"
    echo "  2) åœæ­¢æœåŠ¡"
    echo "  3) é‡å¯æœåŠ¡"
    echo "  4) æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  5) é‡æ–°åŠ è½½é…ç½®"
    echo
    echo -e "${CYAN}é…ç½®ç®¡ç†:${NC}"
    echo "  6) æŸ¥çœ‹å½“å‰é…ç½®"
    echo "  7) ç¼–è¾‘é…ç½®æ–‡ä»¶"
    echo "  8) æµ‹è¯•é…ç½®è¯­æ³•"
    echo "  9) å¤‡ä»½å½“å‰é…ç½®"
    echo "  10) æ¢å¤é…ç½®å¤‡ä»½"
    echo
    echo -e "${CYAN}æ—¥å¿—å’Œç›‘æ§:${NC}"
    echo "  11) æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo "  12) æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶"
    echo "  13) ç›‘æ§æœåŠ¡çŠ¶æ€"
    echo
    if [[ "$FRP_TYPE" == "server" ]]; then
        echo -e "${CYAN}æœåŠ¡ç«¯åŠŸèƒ½:${NC}"
        echo "  14) æŸ¥çœ‹è¿æ¥ä¿¡æ¯"
        echo
        echo -e "${CYAN}å…¶ä»–åŠŸèƒ½:${NC}"
        echo "  15) æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯"
        echo "  16) æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
        echo "  17) å¸è½½ FRP"
    else
        echo -e "${CYAN}ä»£ç†è§„åˆ™ç®¡ç†:${NC}"
        echo "  14) ä»£ç†è§„åˆ™ç®¡ç†èœå•"
        echo
        echo -e "${CYAN}å…¶ä»–åŠŸèƒ½:${NC}"
        echo "  15) æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯"
        echo "  16) æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
        echo "  17) å¸è½½ FRP"
    fi
    echo "  0)  é€€å‡º"
    echo
    echo -e "${BLUE}========================================${NC}"
}

# æ˜¾ç¤ºä»£ç†è§„åˆ™ç®¡ç†å­èœå•
show_proxy_menu() {
    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        ä»£ç†è§„åˆ™ç®¡ç†${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo
    echo "  1) åˆ—å‡ºæ‰€æœ‰ä»£ç†è§„åˆ™"
    echo "  2) æ·»åŠ ä»£ç†è§„åˆ™"
    echo "  3) åˆ é™¤ä»£ç†è§„åˆ™"
    echo "  4) ç¼–è¾‘ä»£ç†è§„åˆ™"
    echo "  5) æŸ¥çœ‹ä»£ç†è§„åˆ™è¯¦æƒ…"
    echo "  0) è¿”å›ä¸»èœå•"
    echo
    echo -e "${BLUE}========================================${NC}"
}

# æ˜¾ç¤ºæœªå®‰è£…æ—¶çš„èœå•
show_uninstalled_menu() {
    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        FRP å®‰è£…å‘å¯¼${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo
    echo "  1) å®‰è£… FRP æœåŠ¡å™¨ (frps)"
    echo "  2) å®‰è£… FRP å®¢æˆ·ç«¯ (frpc)"
    echo "  3) æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
    echo "  0) é€€å‡º"
    echo
    echo -e "${BLUE}========================================${NC}"
}

# äº¤äº’å¼èœå•å¤„ç†ï¼ˆå·²å®‰è£…çŠ¶æ€ï¼‰
interactive_menu() {
    while true; do
        show_main_menu
        
        # æ ¹æ®FRPç±»å‹ç¡®å®šæœ€å¤§é€‰é¡¹å·
        local max_option=17
        if [[ "$FRP_TYPE" == "server" ]]; then
            max_option=17
        else
            max_option=17
        fi
        
        read -p "è¯·é€‰æ‹©åŠŸèƒ½ [0-$max_option]: " choice

        case "$choice" in
            1)
                cmd_start
                echo
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            2)
                cmd_stop
                echo
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            3)
                cmd_restart
                echo
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            4)
                cmd_status
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            5)
                cmd_reload
                echo
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            6)
                cmd_config
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            7)
                cmd_edit
                echo
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            8)
                cmd_test
                echo
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            9)
                cmd_backup
                echo
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            10)
                cmd_restore
                echo
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            11)
                cmd_logs
                ;;
            12)
                cmd_logf
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            13)
                cmd_monitor
                ;;
            14)
                if [[ "$FRP_TYPE" == "server" ]]; then
                    cmd_connections
                    read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                else
                    interactive_proxy_menu
                fi
                ;;
            15)
                cmd_info
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            16)
                cmd_version
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            17)
                cmd_uninstall_interactive
                ;;
            0)
                log_info "é€€å‡ºç®¡ç†å·¥å…·"
                exit 0
                ;;
            *)
                log_error "æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 0-$max_option ä¹‹é—´çš„æ•°å­—"
                sleep 2
                ;;
        esac
    done
}

# äº¤äº’å¼ä»£ç†è§„åˆ™ç®¡ç†èœå•
interactive_proxy_menu() {
    while true; do
        show_proxy_menu
        read -p "è¯·é€‰æ‹©åŠŸèƒ½ [0-5]: " choice

        case "$choice" in
            1)
                cmd_proxy_list
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            2)
                cmd_proxy_add
                echo
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            3)
                cmd_proxy_delete_interactive
                echo
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            4)
                cmd_proxy_edit_interactive
                echo
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            5)
                cmd_proxy_show_interactive
                echo
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            0)
                return 0
                ;;
            *)
                log_error "æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 0-5 ä¹‹é—´çš„æ•°å­—"
                sleep 1
                ;;
        esac
    done
}

# äº¤äº’å¼åˆ é™¤ä»£ç†è§„åˆ™
cmd_proxy_delete_interactive() {
    if ! check_is_client; then
        return 1
    fi

    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        åˆ é™¤ä»£ç†è§„åˆ™${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo

    # å…ˆåˆ—å‡ºæ‰€æœ‰ä»£ç†è§„åˆ™
    local proxies=$(parse_proxy_list)
    if [[ -z "$proxies" ]]; then
        log_warn "æœªæ‰¾åˆ°ä»»ä½•ä»£ç†è§„åˆ™"
        return
    fi

    echo -e "${CYAN}å¯ç”¨çš„ä»£ç†è§„åˆ™:${NC}"
    echo
    local i=1
    local proxy_names=()
    while IFS='|' read -r name type info; do
        echo "  $i) $name ($type) - $info"
        proxy_names+=("$name")
        ((i++))
    done <<< "$proxies"

    echo
    read -p "è¯·é€‰æ‹©è¦åˆ é™¤çš„ä»£ç†è§„åˆ™ç¼–å· [1-$((i-1))]: " choice

    if [[ ! "$choice" =~ ^[0-9]+$ ]] || [[ $choice -lt 1 ]] || [[ $choice -ge $i ]]; then
        log_error "æ— æ•ˆé€‰æ‹©"
        return 1
    fi

    local proxy_name="${proxy_names[$((choice-1))]}"
    cmd_proxy_delete "$proxy_name"
}

# äº¤äº’å¼ç¼–è¾‘ä»£ç†è§„åˆ™
cmd_proxy_edit_interactive() {
    if ! check_is_client; then
        return 1
    fi

    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        ç¼–è¾‘ä»£ç†è§„åˆ™${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo

    # å…ˆåˆ—å‡ºæ‰€æœ‰ä»£ç†è§„åˆ™
    local proxies=$(parse_proxy_list)
    if [[ -z "$proxies" ]]; then
        log_warn "æœªæ‰¾åˆ°ä»»ä½•ä»£ç†è§„åˆ™"
        return
    fi

    echo -e "${CYAN}å¯ç”¨çš„ä»£ç†è§„åˆ™:${NC}"
    echo
    local i=1
    local proxy_names=()
    while IFS='|' read -r name type info; do
        echo "  $i) $name ($type) - $info"
        proxy_names+=("$name")
        ((i++))
    done <<< "$proxies"

    echo
    read -p "è¯·é€‰æ‹©è¦ç¼–è¾‘çš„ä»£ç†è§„åˆ™ç¼–å· [1-$((i-1))]: " choice

    if [[ ! "$choice" =~ ^[0-9]+$ ]] || [[ $choice -lt 1 ]] || [[ $choice -ge $i ]]; then
        log_error "æ— æ•ˆé€‰æ‹©"
        return 1
    fi

    local proxy_name="${proxy_names[$((choice-1))]}"
    cmd_proxy_edit "$proxy_name"
}

# äº¤äº’å¼æŸ¥çœ‹ä»£ç†è§„åˆ™è¯¦æƒ…
cmd_proxy_show_interactive() {
    if ! check_is_client; then
        return 1
    fi

    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        æŸ¥çœ‹ä»£ç†è§„åˆ™è¯¦æƒ…${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo

    # å…ˆåˆ—å‡ºæ‰€æœ‰ä»£ç†è§„åˆ™
    local proxies=$(parse_proxy_list)
    if [[ -z "$proxies" ]]; then
        log_warn "æœªæ‰¾åˆ°ä»»ä½•ä»£ç†è§„åˆ™"
        return
    fi

    echo -e "${CYAN}å¯ç”¨çš„ä»£ç†è§„åˆ™:${NC}"
    echo
    local i=1
    local proxy_names=()
    while IFS='|' read -r name type info; do
        echo "  $i) $name ($type) - $info"
        proxy_names+=("$name")
        ((i++))
    done <<< "$proxies"

    echo
    read -p "è¯·é€‰æ‹©è¦æŸ¥çœ‹çš„ä»£ç†è§„åˆ™ç¼–å· [1-$((i-1))]: " choice

    if [[ ! "$choice" =~ ^[0-9]+$ ]] || [[ $choice -lt 1 ]] || [[ $choice -ge $i ]]; then
        log_error "æ— æ•ˆé€‰æ‹©"
        return 1
    fi

    local proxy_name="${proxy_names[$((choice-1))]}"
    cmd_proxy_show "$proxy_name"
}

# äº¤äº’å¼å¸è½½
cmd_uninstall_interactive() {
    echo
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}        å¸è½½ FRP${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo
    echo "  1) å¸è½½ FRP æœåŠ¡å™¨ (frps)"
    echo "  2) å¸è½½ FRP å®¢æˆ·ç«¯ (frpc)"
    echo "  3) å®Œå…¨å¸è½½ FRP (æ‰€æœ‰ç»„ä»¶)"
    echo "  0) è¿”å›ä¸»èœå•"
    echo
    echo -e "${BLUE}========================================${NC}"
    echo
    read -p "è¯·é€‰æ‹©å¸è½½ç±»å‹ [0-3]: " choice

    case "$choice" in
        1)
            cmd_uninstall "server"
            echo
            read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
            ;;
        2)
            cmd_uninstall "client"
            echo
            read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
            ;;
        3)
            cmd_uninstall "all"
            ;;
        0)
            return 0
            ;;
        *)
            log_error "æ— æ•ˆé€‰æ‹©"
            sleep 1
            ;;
    esac
}

# äº¤äº’å¼å®‰è£…èœå•
interactive_install_menu() {
    while true; do
        show_uninstalled_menu
        read -p "è¯·é€‰æ‹©åŠŸèƒ½ [0-3]: " choice

        case "$choice" in
            1)
                cmd_install "server"
                break
                ;;
            2)
                cmd_install "client"
                break
                ;;
            3)
                cmd_version
                echo
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            0)
                log_info "é€€å‡ºå®‰è£…å‘å¯¼"
                exit 0
                ;;
            *)
                log_error "æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 0-3 ä¹‹é—´çš„æ•°å­—"
                sleep 1
                ;;
        esac
    done
}

# ä¸»å‡½æ•°
main() {
    local command="$1"
    local subcommand="$2"

    # å¦‚æœæ²¡æœ‰æä¾›å‘½ä»¤æˆ–å‘½ä»¤ä¸ºç©ºï¼Œæ˜¾ç¤ºäº¤äº’å¼èœå•
    if [[ -z "$command" ]] || [[ "$command" == "" ]]; then
        if check_installation; then
            interactive_menu
        else
            interactive_install_menu
        fi
        return
    fi

    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
    if check_installation; then
        # å·²å®‰è£…ï¼Œæ‰§è¡Œç®¡ç†å‘½ä»¤
        case "$command" in
            start)
                cmd_start
                ;;
            stop)
                cmd_stop
                ;;
            restart)
                cmd_restart
                ;;
            status)
                cmd_status
                ;;
            config)
                cmd_config
                ;;
            edit)
                cmd_edit
                ;;
            test)
                cmd_test
                ;;
            reload)
                cmd_reload
                ;;
            logs)
                cmd_logs
                ;;
            logf)
                cmd_logf
                ;;
            backup)
                cmd_backup
                ;;
            restore)
                cmd_restore
                ;;
            version)
                cmd_version
                ;;
            info)
                cmd_info
                ;;
            connections)
                cmd_connections
                ;;
            monitor)
                cmd_monitor
                ;;
            uninstall)
                cmd_uninstall "$subcommand"
                ;;
            proxy)
                cmd_proxy "$subcommand" "$3"
                ;;
            install)
                log_error "FRP å·²å®‰è£…ï¼Œå¦‚éœ€é‡æ–°å®‰è£…è¯·å…ˆè¿è¡Œ: frp uninstall"
                ;;
            help)
                show_installed_help
                ;;
            *)
                log_error "æœªçŸ¥å‘½ä»¤: $command"
                echo
                log_info "è¿è¡Œ 'frp' è¿›å…¥äº¤äº’å¼èœå•"
                log_info "è¿è¡Œ 'frp help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤"
                exit 1
                ;;
        esac
    else
        # æœªå®‰è£…ï¼Œæ‰§è¡Œå®‰è£…å‘½ä»¤
        case "$command" in
            install)
                cmd_install "$subcommand"
                ;;
            help)
                show_uninstalled_help
                ;;
            version)
                cmd_version
                ;;
            *)
                log_error "FRP æœªå®‰è£…ï¼Œè¯·å…ˆè¿è¡Œå®‰è£…å‘½ä»¤"
                log_info "è¿è¡Œ 'frp' è¿›å…¥äº¤äº’å¼å®‰è£…èœå•"
                log_info "è¿è¡Œ 'frp install' å¼€å§‹å®‰è£…"
                log_info "è¿è¡Œ 'frp help' æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯"
                exit 1
                ;;
        esac
    fi
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"
